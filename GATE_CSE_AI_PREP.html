<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATE Preparation</title> <!-- Title will be updated by JS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library for Confetti Effect -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- KaTeX Library for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOV3CQDEZwgWBEJhUysllcUHzIYTcqu08i4LagTBKNzzGv8vrI3A" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <style>
        /* CSS Variables for enhanced theming */
        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --card-bg: #ffffff;
            --header-bg-start: #667eea;
            --header-bg-end: #764ba2;
            --section-header-bg: #f1f5f9;
            --section-header-hover-bg: #e2e8f0;
            --section-completed-bg: #dcfce7;
            --section-completed-text: #166534;
            --section-partial-bg: #fef3c7;
            --section-partial-text: #92400e;
            --syllabus-item-bg: #ffffff;
            --syllabus-item-hover-bg: #f8fafc;
            --border-color: #e2e8f0;
            --checkbox-border: #94a3b8;
            --chart-title-color: #374151;
            --chart-legend-color: #374151;
            --nav-button-color: #64748b;
            --nav-button-hover-bg: #f1f5f9;
            --nav-button-active-bg: #667eea;
            --nav-button-active-color: #ffffff;
            --chart-details-bg: #f8fafc;
            --chart-details-border: #e2e8f0;
            --congratulations-modal-bg: #ffffff;
            --congratulations-text: #1e293b;
            --login-modal-bg: #ffffff;
            --login-text-color: #1e293b;
            --input-border-color: #cbd5e1;
            --input-focus-border-color: var(--nav-button-active-bg);
            --toast-success-bg: #10b981;
            --toast-error-bg: #ef4444;

            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --accent-red: #ef4444;
            --accent-teal: #14b8a6;
            --accent-indigo: #6366f1;
            --accent-cyan: #06b6d4;
            --accent-emerald: #059669;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        /* Enhanced Dark Mode styles */
        body.dark-mode {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --card-bg: #1e293b;
            --header-bg-start: #475569;
            --header-bg-end: #334155;
            --section-header-bg: #334155;
            --section-header-hover-bg: #475569;
            --section-completed-bg: #065f46;
            --section-completed-text: #d1fae5;
            --section-partial-bg: #78350f;
            --section-partial-text: #fef3c7;
            --syllabus-item-bg: #1e293b;
            --syllabus-item-hover-bg: #334155;
            --border-color: #475569;
            --checkbox-border: #64748b;
            --chart-title-color: #f1f5f9;
            --chart-legend-color: #f1f5f9;
            --nav-button-color: #cbd5e1;
            --nav-button-hover-bg: #334155;
            --nav-button-active-bg: #667eea;
            --nav-button-active-color: #ffffff;
            --chart-details-bg: #1e293b;
            --chart-details-border: #475569;
            --congratulations-modal-bg: #1e293b;
            --congratulations-text: #e2e8f0;
            --login-modal-bg: #1e293b;
            --login-text-color: #e2e8f0;
            --input-border-color: #475569;
            --input-focus-border-color: var(--nav-button-active-bg);
            --toast-success-bg: #059669;
            --toast-error-bg: #b91c1c;

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.3);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            overflow-x: hidden;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
        }
        html.modal-open,
        body.modal-open { 
            overflow: hidden !important;
        }

        .main-wrapper {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            overflow: hidden;
            width: 100%;
        }

        @media (min-width: 768px) {
            .card {
                padding: 2rem;
                margin-bottom: 2rem;
                border-radius: 20px;
            }
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }
        .card .section-header { 
             background-color: var(--card-bg) !important; 
             border-radius: 12px;
             padding: 1rem 1.5rem; 
        }
        .card .section-header:hover {
            background-color: var(--section-header-hover-bg) !important;
        }
        .card .section-header h2 {
            color: var(--chart-title-color); 
        }


        .header {
            background: linear-gradient(135deg, var(--header-bg-start) 0%, var(--header-bg-end) 100%);
            color: #ffffff;
            padding: 2rem 1rem 4rem 1rem;
            text-align: center;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s ease;
            overflow: visible;
            width: 100%;
        }

        @media (min-width: 768px) {
            .header {
                padding: 3rem 2rem 5rem 2rem;
                margin-bottom: 2rem;
                border-bottom-left-radius: 30px;
                border-bottom-right-radius: 30px;
            }
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0;
        }

        @media (min-width: 768px) {
            .header h1 {
                font-size: 3rem;
                margin-bottom: 1rem;
            }
            
            .header p {
                font-size: 1.5rem;
            }
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--chart-title-color);
            margin-bottom: 1.5rem;
            transition: color 0.3s ease;
            text-align: center;
        }

        @media (min-width: 768px) {
            .section-title {
                font-size: 1.75rem;
                text-align: left;
            }
        }
        .card .section-header .section-title { 
            margin-bottom: 0;
            text-align: left;
        }


        .nav-buttons {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            background-color: var(--card-bg);
            padding: 6px;
            border-radius: 50px;
            box-shadow: var(--shadow-xl);
            z-index: 100;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            flex-direction: row;
            width: auto;
            max-width: 90%;
        }

        @media (max-width: 767px) {
            .nav-buttons {
                bottom: -25px;
                flex-direction: column;
                border-radius: 20px;
                width: 280px;
                gap: 4px;
                padding: 8px;
            }
        }

        .nav-button {
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--nav-button-color);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            border: none;
            background: none;
            position: relative;
            overflow: hidden;
            text-align: center;
            min-width: 120px;
        }

        @media (min-width: 768px) {
            .nav-button {
                padding: 12px 24px;
                font-size: 0.95rem;
                min-width: 150px;
            }
        }

        @media (max-width: 767px) {
            .nav-button {
                border-radius: 15px;
                width: 100%;
                margin: 0;
            }
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .nav-button:hover::before {
            left: 100%;
        }

        .nav-button:hover {
            transform: translateY(-1px);
            background-color: var(--nav-button-hover-bg);
            box-shadow: var(--shadow-md);
        }

        .nav-button.active {
            background: linear-gradient(135deg, var(--nav-button-active-bg) 0%, var(--header-bg-end) 100%);
            color: var(--nav-button-active-color);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(0);
        }

        .syllabus-section-container {
            margin-bottom: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        @media (min-width: 768px) {
            .syllabus-section-container {
                margin-bottom: 2rem;
                border-radius: 16px;
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 1rem;
            background-color: var(--section-header-bg);
            transition: all 0.3s ease;
            border-radius: 12px;
            border: 2px solid transparent;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        @media (min-width: 768px) {
            .section-header {
                padding: 1.5rem;
                border-radius: 16px;
                flex-wrap: nowrap;
                gap: 0;
            }
        }

        .section-header:hover {
            background-color: var(--section-header-hover-bg);
            transform: translateX(3px);
            border-color: var(--nav-button-active-bg);
            box-shadow: var(--shadow-md);
        }

        @media (min-width: 768px) {
            .section-header:hover {
                transform: translateX(6px);
            }
        }

        .section-header.math-section { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; }
        .section-header.math-section:hover { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        .section-header.digital-section { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .section-header.digital-section:hover { background: linear-gradient(135deg, #0d9488 0%, #047857 100%); }
        .section-header.computer-org-section { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .section-header.computer-org-section:hover { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); }
        .section-header.programming-section { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .section-header.programming-section:hover { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); }
        .section-header.algorithms-section { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .section-header.algorithms-section:hover { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .section-header.theory-section { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; }
        .section-header.theory-section:hover { background: linear-gradient(135deg, #db2777 0%, #be185d 100%); }
        .section-header.compiler-section { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); color: white; }
        .section-header.compiler-section:hover { background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); }
        .section-header.os-section { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; }
        .section-header.os-section:hover { background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); }
        .section-header.database-section { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; }
        .section-header.database-section:hover { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }
        .section-header.network-section { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; }
        .section-header.network-section:hover { background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); }
        .section-header.aptitude-section { background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); color: white; }
        .section-header.aptitude-section:hover { background: linear-gradient(135deg, #65a30d 0%, #4d7c0f 100%); }

        .card .section-header:not([class*="-section"]) {
            background: var(--card-bg); 
        }
        .card .section-header:not([class*="-section"]):hover {
            background: var(--section-header-hover-bg); 
        }
         .card .section-header:not([class*="-section"]) h3,
         .card .section-header:not([class*="-section"]) .section-title {
            color: var(--chart-title-color) !important; 
        }


        .section-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
        }

        @media (min-width: 768px) {
            .section-header h3 {
                font-size: 1.3rem;
                min-width: auto;
            }
        }

        .section-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            margin-right: 0.75rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
        }

        @media (min-width: 768px) {
            .section-number {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                margin-right: 1rem;
            }
        }

        .toggle-section svg, .toggle-subtopics svg, .toggle-card-content svg {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255, 255, 255, 0.8); 
            flex-shrink: 0;
            width: 20px;
            height: 20px;
        }
        
        body:not(.dark-mode) .syllabus-item .toggle-subtopics svg {
            color: var(--text-color); 
        }
        body:not(.dark-mode) .card .section-header:not([class*="-section"]) .toggle-card-content svg {
             color: var(--text-color);
        }
        body.dark-mode .syllabus-item .toggle-subtopics svg,
        body.dark-mode .card .section-header:not([class*="-section"]) .toggle-card-content svg {
             color: var(--text-color); 
        }


        @media (min-width: 768px) {
            .toggle-section svg, .toggle-subtopics svg, .toggle-card-content svg {
                width: 24px;
                height: 24px;
            }
        }

        .toggle-section svg.rotate-180, .toggle-subtopics svg.rotate-180, .toggle-card-content svg.rotate-180 {
            transform: rotate(180deg);
        }

        .section-topics-list, .card-content-collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            padding-left: 1rem;
            border-left: 4px solid var(--border-color);
            margin-top: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0.3) 100%);
            border-radius: 0 0 12px 12px;
        }
         .card-content-collapsible { 
            background: var(--card-bg); 
            border-left: none; 
            padding-left: 0;
        }


        @media (min-width: 768px) {
            .section-topics-list, .card-content-collapsible {
                padding-left: 1.5rem;
                border-radius: 0 0 16px 16px;
            }
            .card-content-collapsible { padding-left: 0; }
        }

        body.dark-mode .section-topics-list {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.1) 100%);
        }
        body.dark-mode .card-content-collapsible {
            background: var(--card-bg); 
        }


        .section-topics-list.expanded, .card-content-collapsible.expanded {
            max-height: 7000px; 
            padding: 1rem;
        }
        .card-content-collapsible.expanded {
             padding-top: 1.5rem; 
        }


        @media (min-width: 768px) {
            .section-topics-list.expanded, .card-content-collapsible.expanded {
                padding: 1.5rem;
            }
             .card-content-collapsible.expanded {
                 padding-top: 2rem;
             }
        }

        .syllabus-item {
            cursor: default; 
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            background-color: var(--syllabus-item-bg);
            box-shadow: var(--shadow-sm);
            border: 2px solid var(--border-color);
        }

        @media (min-width: 768px) {
            .syllabus-item {
                padding: 1.5rem;
                border-radius: 12px;
                margin-bottom: 1rem;
            }
        }

        .syllabus-item:hover { 
            background-color: var(--syllabus-item-hover-bg);
            box-shadow: var(--shadow-lg);
            border-color: var(--nav-button-active-bg);
        }

        .responsive-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            width: 100%;
        }

        @media (min-width: 768px) {
            .responsive-grid {
                gap: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .responsive-grid.two-col {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
        }

        .chart-container {
            position: relative;
            height: 280px;
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
                padding: 1.5rem;
                border-radius: 16px;
                margin-bottom: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .chart-container {
                height: 400px;
            }
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }
        .card .section-header:not([class*="-section"]) .progress-indicator {
            color: var(--text-color); 
        }


        @media (min-width: 768px) {
            .progress-indicator {
                gap: 0.75rem;
                font-size: 0.95rem;
            }
        }

        .progress-bar {
            width: 60px;
            height: 6px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }
        .card .section-header:not([class*="-section"]) .progress-bar {
            background-color: var(--border-color); 
        }


        @media (min-width: 768px) {
            .progress-bar {
                width: 80px;
                height: 8px;
                border-radius: 4px;
            }
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #10b981 100%);
            transition: width 0.5s ease;
            border-radius: inherit;
        }

        .study-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        @media (min-width: 768px) {
            .study-stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 1.5rem;
                border-radius: 16px;
            }
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: var(--nav-button-active-bg);
        }

        @media (min-width: 768px) {
            .stat-card:hover {
                transform: translateY(-4px);
            }
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--nav-button-active-bg) 0%, var(--header-bg-end) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        @media (min-width: 768px) {
            .stat-number {
                font-size: 2rem;
            }
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.8;
            font-weight: 500;
        }

        @media (min-width: 768px) {
            .stat-label {
                font-size: 1rem;
            }
        }

        .page {
            width: 100%;
            display: none; 
            overflow-x: hidden; 
            z-index: 1; 
        }

        .page.active {
            display: block; 
            position: relative; 
            z-index: 10; 
        }

        .header-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .header-icon-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            cursor: pointer;
            color: white;
            padding: 0.75rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .header-controls {
                top: 1.5rem;
                right: 1.5rem;
                 gap: 0.75rem;
            }
            .header-icon-button {
                padding: 1rem;
                width: 48px;
                height: 48px;
            }
        }

        .header-icon-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        #themeToggle:hover {
            transform: rotate(180deg) scale(1.1);
        }


        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        @media (min-width: 768px) {
            .table-container {
                border-radius: 16px;
            }
        }

        .weightage-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 600px;
        }

        @media (min-width: 768px) {
            .weightage-table {
                font-size: 1rem;
                min-width: auto;
            }
        }

        .weightage-table th {
            background-color: var(--section-header-bg);
            color: var(--text-color);
            font-weight: 600;
            padding: 1rem 0.75rem;
            text-align: left;
            font-size: 0.95rem;
        }

        @media (min-width: 768px) {
            .weightage-table th {
                padding: 1.5rem 1rem;
                font-size: 1.1rem;
            }
        }

        .weightage-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .weightage-table td {
                padding: 1rem;
            }
        }

        .weightage-table tbody tr {
            transition: all 0.3s ease;
        }

        .weightage-table tbody tr:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: scale(1.01);
        }

        @media (min-width: 768px) {
            .weightage-table tbody tr:hover {
                transform: scale(1.02);
            }
        }

        .weightage-table tbody tr:nth-child(even) {
            background-color: rgba(0,0,0,0.02);
        }

        body.dark-mode .weightage-table tbody tr:nth-child(even) {
            background-color: rgba(255,255,255,0.05);
        }

        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
            flex-direction: row;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .timeline-item {
                margin-bottom: 2rem;
                padding: 1.5rem;
                border-radius: 16px;
            }
        }

        .timeline-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: var(--nav-button-active-bg);
        }

        @media (min-width: 768px) {
            .timeline-item:hover {
                transform: translateY(-4px);
            }
        }

        .timeline-icon {
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .timeline-icon {
                font-size: 2.5rem;
            }
        }

        .timeline-text {
            font-size: 1rem;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        @media (min-width: 768px) {
            .timeline-text {
                font-size: 1.1rem;
            }
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--checkbox-border);
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .checkbox {
                width: 24px;
                height: 24px;
                border-radius: 8px;
                margin-right: 1rem;
            }
        }

        .checkbox:hover {
            transform: scale(1.1);
            border-color: var(--accent-green);
        }
        
        .syllabus-item.completed > .syllabus-item-header .checkbox,
        .sub-topic-item.completed .checkbox {
            background-color: var(--accent-green);
            border-color: var(--accent-green);
            animation: check-bounce 0.5s ease;
        }

        .syllabus-item.partially-completed > .syllabus-item-header .checkbox,
        .sub-topic-item.partial .checkbox { 
            background-color: var(--accent-yellow);
            border-color: var(--accent-yellow);
        }

        @keyframes check-bounce {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .checkbox svg {
            display: none;
            color: #ffffff;
            width: 12px;
            height: 12px;
        }

        @media (min-width: 768px) {
            .checkbox svg {
                width: 16px;
                height: 16px;
            }
        }

        .syllabus-item.completed > .syllabus-item-header .checkbox svg,
        .syllabus-item.partially-completed > .syllabus-item-header .checkbox svg,
        .sub-topic-item.completed .checkbox svg,
        .sub-topic-item.partial .checkbox svg { 
            display: block;
        }

        .topic-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
            align-items: center;
        }

        .llm-buttons {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .llm-buttons {
                flex-wrap: nowrap;
            }
        }

        .llm-button, .resource-button {
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid var(--nav-button-active-bg);
            background-color: var(--nav-button-active-bg);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            white-space: nowrap;
        }
        .resource-button {
            background-color: var(--accent-teal);
            border-color: var(--accent-teal);
        }

        @media (min-width: 768px) {
            .llm-button, .resource-button {
                padding: 0.4rem 0.8rem;
                border-radius: 20px;
                font-size: 0.8rem;
            }
        }

        .llm-button:hover:not(.disabled), .resource-button:hover {
            background-color: var(--header-bg-end);
            border-color: var(--header-bg-end);
            transform: translateY(-1px);
        }
        .resource-button:hover {
            background-color: var(--accent-emerald);
            border-color: var(--accent-emerald);
        }

        .llm-button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--nav-button-color);
            border-color: var(--nav-button-color);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            padding: 1rem;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content-box {
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            max-width: 95%;
            width: 100%;
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            max-height: 90vh; 
            display: flex;
            flex-direction: column;
        }
        .modal-content-box-inner {
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .modal-content-box {
                padding: 2rem;
            }
        }

        .modal-overlay.show .modal-content-box {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-close-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-color);
            transition: color 0.2s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            z-index: 10; 
        }

        @media (min-width: 768px) {
            .modal-close-button {
                top: 1rem;
                right: 1rem;
                font-size: 1.5rem;
                width: 36px;
                height: 36px;
            }
        }

        .modal-close-button:hover {
            color: var(--nav-button-active-bg);
            background-color: var(--nav-button-hover-bg);
        }

        .modal-content-box h3 { 
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--chart-title-color);
            padding-right: 2rem; 
            flex-shrink: 0; 
        }

        @media (min-width: 768px) {
            .modal-content-box h3 {
                font-size: 1.5rem;
            }
        }
        
         /* Markdown rendered content styling */
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5,
        .llm-message h1, .llm-message h2, .llm-message h3, .llm-message h4, .llm-message h5  { 
            color: var(--chart-title-color);
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }
        .markdown-content h1, .llm-message h1 { font-size: 1.6em; }
        .markdown-content h2, .llm-message h2 { font-size: 1.4em; }
        .markdown-content h3, .llm-message h3 { font-size: 1.2em; }
        .markdown-content h4, .llm-message h4 { font-size: 1.1em; color: var(--nav-button-active-bg); }
        .markdown-content p, .llm-message p { margin-bottom: 0.8em; }
        .markdown-content ul, .markdown-content ol, .llm-message ul, .llm-message ol { margin-left: 1.5em; margin-bottom: 0.8em; list-style-position: outside; }
        .markdown-content li, .llm-message li { margin-bottom: 0.3em; }
        .markdown-content code:not(pre code), .llm-message code:not(pre code) { 
            background-color: var(--section-header-bg);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: var(--accent-pink);
        }
        body.dark-mode .markdown-content code:not(pre code), body.dark-mode .llm-message code:not(pre code) {
            color: var(--accent-teal); 
        }
        .markdown-content pre, .llm-message pre {
            background-color: var(--section-header-bg);
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.8em 0;
            border: 1px solid var(--border-color);
        }
        .markdown-content pre code, .llm-message pre code { 
            background-color: transparent;
            padding: 0;
            color: var(--text-color); 
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }
        body.dark-mode .markdown-content pre code, body.dark-mode .llm-message pre code {
             color: var(--text-color);
        }
        .markdown-content table, .llm-message table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            box-shadow: var(--shadow-sm);
        }
        .markdown-content th, .markdown-content td, .llm-message th, .llm-message td {
            border: 1px solid var(--border-color);
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .markdown-content th, .llm-message th {
            background-color: var(--section-header-bg);
            font-weight: 600;
        }
        .markdown-content blockquote, .llm-message blockquote {
            border-left: 4px solid var(--nav-button-active-bg);
            padding-left: 1em;
            margin: 1em 0 1em 0; 
            font-style: italic;
            color: var(--nav-button-color);
        }

        .llm-modal-content { 
            flex: 1; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .llm-modal-content .question-text { font-weight: bold; margin-bottom: 1em; font-size: 1.1em; }
        .llm-modal-content .options-container { margin-bottom: 1em; }
        /* [FIX] Enhanced MCQ Option Styling */
        .llm-modal-content .options-container label {
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Vertically center items */
            margin-bottom: 0.75em;
            padding: 0.75em 1em;
            border-radius: 8px;
            background-color: var(--syllabus-item-hover-bg);
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.2s ease;
        }
        .llm-modal-content .options-container label:hover {
            background-color: var(--section-header-hover-bg);
            border-color: var(--nav-button-active-bg);
        }
        .llm-modal-content .options-container input[type="radio"] {
            /* Make the radio button bigger and easier to click */
            width: 1.25em;
            height: 1.25em;
            margin-right: 0.75em; /* Add space between button and text */
            flex-shrink: 0; /* Prevent the button from shrinking */
            accent-color: var(--nav-button-active-bg);
        }

        /* [NEW] Styling for NAT input */
        .nat-input-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .nat-input {
            flex-grow: 1;
            padding: 0.75rem;
            font-size: 1.1rem;
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            border: 2px solid var(--input-border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .nat-input:focus {
            outline: none;
            border-color: var(--input-focus-border-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        .llm-modal-content .options-container label.correct {
            background-color: var(--section-completed-bg);
            border-color: var(--accent-green);
            color: var(--section-completed-text);
            font-weight: bold;
        }
        .llm-modal-content .options-container label.incorrect {
            background-color: #fee2e2; /* Light red */
            border-color: var(--accent-red);
            color: #991b1b; /* Dark red */
        }
        body.dark-mode .llm-modal-content .options-container label.incorrect {
            background-color: #7f1d1d;
            color: #fecaca;
        }
/* [REFACTORED] Resource List (Stack) Styling */
.resource-stack {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.resource-stack-item {
    display: flex;
    flex-direction: column; /* Mobile-first: thumbnail on top */
    gap: 1rem;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
    border: 1px solid var(--border-color);
    background-color: var(--syllabus-item-bg);
    padding: 1rem;
}
.resource-stack-item:hover {
    box-shadow: var(--shadow-lg);
    border-color: var(--nav-button-active-bg);
    cursor: pointer;
}
.resource-stack-item .thumbnail-container {
    flex-shrink: 0;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
}
.resource-stack-item .thumbnail-container img,
.resource-stack-item .thumbnail-container .link-icon {
    width: 100%;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    display: block;
    background-color: var(--section-header-bg);
}
.resource-stack-item .thumbnail-container .link-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}
.resource-stack-item .thumbnail-container .link-icon svg {
    width: 48px;
    height: 48px;
    color: var(--nav-button-active-bg);
    opacity: 0.7;
}
.resource-stack-item .info-container {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-width: 0; /* Important for flex text wrapping */
}
.resource-stack-item .title {
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: 0.25rem;
}
.resource-stack-item .author {
    font-size: 0.85rem;
    color: var(--text-color);
    opacity: 0.7;
}
.resource-stack-item .delete-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    cursor: pointer;
    z-index: 5;
    transition: all 0.2s ease;
}
.resource-stack-item .delete-btn:hover {
    background-color: var(--accent-red);
    transform: scale(1.1);
}

/* Desktop layout for resource list items */
@media (min-width: 768px) {
    .resource-stack-item {
        flex-direction: row; /* Side-by-side on desktop */
        align-items: flex-start;
    }
    .resource-stack-item .thumbnail-container {
        width: 180px; /* Fixed width for thumbnail */
    }
}


/* [REFACTORED] Video+Chat Modal Layout */
#videoChatModalBox {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    flex-direction: column; /* Mobile-first: stacked */
}
#videoPlayerContainer {
    flex-shrink: 0;
    position: relative;
}
#videoChatContainer {
    flex-grow: 1;
    min-height: 0; /* Critical for flex child scrolling */
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}
#toggleChatBtn {
   display : none; /* Hidden by default, shown in desktop layout */
    position: absolute;
    top: 1rem;
    right: 1rem;
    background-color: var(--nav-button-hover-bg);
    border: 1px solid var(--border-color);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 1000; /* Ensure it's on top */
}
#toggleChatBtn:hover {
    background-color: var(--nav-button-active-bg);
}

/* [REVISED] Best-in-class Interactive Button Styling and Logic */
@media (min-width: 1024px) {
    /* Main layout styles (keep as they are) */
    #videoChatModalBox {
        flex-direction: row; gap: 1.5rem; padding: 1.5rem;
    }
    #videoPlayerContainer {
        flex: 2; min-width: 0; transition: flex 0.4s ease-in-out;
    }
    #videoChatContainer {
        flex: 1; border-left: 1px solid var(--border-color); padding-left: 1.5rem;
        transition: all 0.4s ease-in-out; opacity: 1; overflow: visible;
    }

    /* 1. Make the BUTTON container larger */
    #toggleChatBtn {
        position: absolute;
        top: 1rem;
        right: 3.5rem;
        background-color: var(--nav-button-hover-bg);
        border: 1px solid var(--border-color);
        /* CHANGED: Increased from 38px to 46px */
        width: 46px;
        height: 46px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1005;
    }
    #toggleChatBtn:hover {
        background-color: var(--border-color);
        transform: scale(1.1) rotate(180deg);
    }

    /* 2. Make the ICONS inside the button larger */
    #toggleChatBtn .icon-hide-chat,
    #toggleChatBtn .icon-robot {
        /* CHANGED: Increased from 28px to 36px */
        width: 36px;
        height: 36px;
        color: var(--text-color);
        transition: all 0.3s ease;
    }
    #toggleChatBtn:hover {
        background-color: var(--border-color);
        transform: scale(1.1) rotate(180deg); /* Nice interactive spin */
    }

    /* 2. Style the icons inside the button */
    #toggleChatBtn svg {
        width: 20px;
        height: 20px;
        color: var(--text-color);
        transition: opacity 0.3s ease;
    }

    /* 3. Logic to show/hide icons based on state */
    /* By default, show the "Hide" icon (>) and hide the "Show" icon (chat) */
    #toggleChatBtn .icon-show-chat {
        display: none;
    }
   
    /* 3. [NEW] Add the GLOW effect to your custom robot SVG */
    #toggleChatBtn .icon-robot {
        /* Sun-like glowing orange boundary around the circle */
        stroke: #f97316; /* orange-500 */
        stroke-width: 18px;
        filter:
            drop-shadow(0 0 12px #f97316)   /* strong orange glow */
            drop-shadow(0 0 28px #fbbf24)   /* yellow glow */
            drop-shadow(0 0 48px #fde68a);  /* soft yellow glow */
        }
        /* Stronger sun glow on hover */
        #toggleChatBtn:hover .icon-robot {
        stroke: #ea580c; /* orange-600 */
        filter:
            drop-shadow(0 0 20px #ea580c)
            drop-shadow(0 0 36px #fbbf24)
            drop-shadow(0 0 60px #fde68a);
        }
        body.dark-mode #toggleChatBtn .icon-robot {
        /* Even brighter sun glow for dark mode */
        stroke: #fbbf24; /* yellow-400 */
        filter:
            drop-shadow(0 0 24px #fbbf24)
            drop-shadow(0 0 48px #f97316)
            drop-shadow(0 0 80px #fde68a);
        }


    /* 4. Logic to show/hide icons (no change, but shown for context) */
    #toggleChatBtn .icon-show-chat {
        display: none;
    }
    #toggleChatBtn .icon-hide-chat {
        display: block;
    }
    #videoChatModalBox.chat-hidden #toggleChatBtn .icon-show-chat {
        display: block;
    }
    #videoChatModalBox.chat-hidden #toggleChatBtn .icon-hide-chat {
        display: none;
    }


    /* When chat is hidden, flip the icons */
    #videoChatModalBox.chat-hidden #toggleChatBtn .icon-show-chat {
        display: block;
    }
    #videoChatModalBox.chat-hidden #toggleChatBtn .icon-hide-chat {
        display: none;
    }
    
    /* 4. Logic to hide the chat panel and expand the video */
    #videoChatModalBox.chat-hidden #videoChatContainer {
        flex: 0;
        width: 0;
        padding: 0;
        margin-left: -1.5rem;
        opacity: 0;
        overflow: hidden;
        border-left: none;
    }
    #videoChatModalBox.chat-hidden #videoPlayerContainer {
        flex: 1;
    }
    #videoChatModalBox.chat-hidden #toggleChatBtn {
        right: 1rem; /* Move button to the edge */
    }
}


        .llm-modal-content .llm-action-buttons { 
            margin-top: 1em; 
            display: flex; 
            gap: 0.75em; 
            flex-wrap: wrap; 
            justify-content: center; 
        }
         .llm-modal-content .llm-action-buttons .llm-button { 
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        .llm-modal-content #llmAnswerArea {
            margin-top:1.5em; 
            padding:1em; 
            border-radius:8px; 
            display:none;
            line-height: 1.5;
            background-color: var(--section-header-bg);
            border: 1px solid var(--border-color);
        }

        /* Difficulty Selector */
        .difficulty-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            justify-content: center;
        }
        .difficulty-button {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 2px solid var(--border-color);
            background-color: var(--syllabus-item-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .difficulty-button:hover {
            border-color: var(--nav-button-active-bg);
            color: var(--nav-button-active-bg);
        }
        .difficulty-button.active {
            color: white;
        }
        .difficulty-button.easy.active { background-color: var(--accent-green); border-color: var(--accent-green); }
        .difficulty-button.moderate.active { background-color: var(--accent-yellow); border-color: var(--accent-yellow); }
        .difficulty-button.hard.active { background-color: var(--accent-red); border-color: var(--accent-red); }


        /* Chat specific styles */
        .llm-chat-interface { 
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            overflow: hidden; 
            min-height: 0; 
        }
        .llm-chat-interface.has-explanation-header {
             border-top: 1px solid var(--border-color);
             padding-top: 1rem;
        }

        .llm-chat-log { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            min-height: 100px; 
        }
        
        /* Custom Scrollbar Styling */
        .markdown-content, .llm-chat-log, .resource-list, .modal-content-box-inner {
            scrollbar-width: thin;
            scrollbar-color: var(--nav-button-active-bg) transparent; 
        }
        body.dark-mode .markdown-content, body.dark-mode .llm-chat-log, body.dark-mode .resource-list, body.dark-mode .modal-content-box-inner {
            scrollbar-color: var(--nav-button-active-bg) transparent; 
        }

        .markdown-content::-webkit-scrollbar, .llm-chat-log::-webkit-scrollbar, .resource-list::-webkit-scrollbar, .modal-content-box-inner::-webkit-scrollbar {
            width: 8px; 
        }

        .markdown-content::-webkit-scrollbar-track, .llm-chat-log::-webkit-scrollbar-track, .resource-list::-webkit-scrollbar-track, .modal-content-box-inner::-webkit-scrollbar-track {
            background: transparent; 
        }

        .markdown-content::-webkit-scrollbar-thumb, .llm-chat-log::-webkit-scrollbar-thumb, .resource-list::-webkit-scrollbar-thumb, .modal-content-box-inner::-webkit-scrollbar-thumb {
            background-color: var(--nav-button-color); 
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .markdown-content::-webkit-scrollbar-thumb:hover, .llm-chat-log::-webkit-scrollbar-thumb:hover, .resource-list::-webkit-scrollbar-thumb:hover, .modal-content-box-inner::-webkit-scrollbar-thumb:hover {
            background-color: var(--nav-button-active-bg); 
        }
        /* END Custom Scrollbar Styling */


        .llm-chat-log .user-message, .llm-chat-log .llm-message {
            padding: 0.6rem 1rem; 
            border-radius: 12px; 
            margin-bottom: 0.75rem; 
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5; 
        }
        .llm-chat-log .user-message {
            background-color: var(--nav-button-active-bg);
            color: var(--nav-button-active-color);
            margin-left: auto;
            text-align: left; 
            border-bottom-right-radius: 4px; 
        }
        .llm-chat-log .llm-message {
            background-color: var(--section-header-bg);
            color: var(--text-color);
            margin-right: auto;
            border-bottom-left-radius: 4px; 
        }
        .llm-chat-input-area { 
            display: flex;
            gap: 0.5rem;
            padding-top: 0.5rem; 
            flex-shrink: 0; 
        }
        .llm-chat-input-area input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            background-color: var(--syllabus-item-bg); 
            color: var(--text-color);
        }
        .llm-chat-input-area input:focus {
            outline: none;
            border-color: var(--input-focus-border-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        .llm-chat-input-area button {
            padding: 0.75rem 1rem;
             flex-shrink: 0; 
        }


        @media (min-width: 768px) {
            .markdown-content { /* For question area */
                font-size: 1rem;
            }
        }

        .congratulations-overlay, .login-congrats-overlay, .user-details-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            backdrop-filter: blur(5px);
            padding: 1rem;
        }

        .congratulations-overlay.show, .login-congrats-overlay.show, .user-details-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .congratulations-modal, .login-congrats-modal, .user-details-modal {
            background-color: var(--congratulations-modal-bg); 
            padding: 2rem 1.5rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(-50px) scale(0.9);
            opacity: 0;
            animation: modal-pop-in 0.6s forwards cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 90%;
            width: 100%;
            max-width: 500px;
            transition: background-color 0.3s ease, color 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .user-details-modal {
             background-color: var(--login-modal-bg);
             color: var(--login-text-color);
             text-align: left;
        }
        .user-details-modal h2 {
            color: var(--chart-title-color); 
            text-align: center;
        }


        @media (min-width: 768px) {
            .congratulations-modal, .login-congrats-modal, .user-details-modal {
                padding: 3rem 2rem;
                border-radius: 20px;
            }
        }

        @keyframes modal-pop-in {
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .congratulations-modal h2, .login-congrats-modal h2 {
            font-size: 2rem;
            color: var(--accent-green);
            margin-bottom: 1rem;
            animation: party-pop 1.5s infinite alternate ease-in-out;
        }
         .user-details-modal h2 { 
            animation: none;
         }


        @media (min-width: 768px) {
            .congratulations-modal h2, .login-congrats-modal h2 {
                font-size: 3rem;
            }
             .user-details-modal h2 {
                font-size: 2rem;
            }
        }

        @keyframes party-pop {
            0% { transform: scale(1) rotate(-2deg); }
            100% { transform: scale(1.05) rotate(2deg); }
        }

        .congratulations-modal p, .login-congrats-modal p {
            font-size: 1rem;
            color: var(--congratulations-text);
            margin-bottom: 1.5rem;
            transition: color 0.3s ease;
        }
         .user-details-modal p {
            color: var(--login-text-color);
         }

        @media (min-width: 768px) {
            .congratulations-modal p, .login-congrats-modal p {
                font-size: 1.25rem;
                margin-bottom: 2rem;
            }
        }

        .primary-button {
            background: linear-gradient(135deg, var(--nav-button-active-bg) 0%, var(--header-bg-end) 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            display: block; 
            margin: 1.5rem auto 0 auto; 
            width: 100%;
        }

        @media (min-width: 768px) {
            .primary-button {
                padding: 1rem 2rem;
                border-radius: 50px;
                font-size: 1.1rem;
            }
        }

        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--login-text-color);
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            background-color: var(--bg-color); 
            color: var(--text-color); 
            transition: border-color 0.3s ease;
            font-size: 1rem;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--input-focus-border-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); 
        }
        body.dark-mode .form-input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }


        .loading-spinner { 
            display: inline-block;
            width: 24px; 
            height: 24px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--nav-button-active-bg);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px; 
        }
        .markdown-content .loading-container,
        .llm-chat-log .loading-container,
        #questionDisplayArea .loading-container
         {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px; 
            font-size: 1.1em;
            color: var(--text-color);
        }
        .llm-chat-log .loading-container {
            min-height: auto; 
            padding: 0.6rem 1rem;
            justify-content: flex-start;
            background-color: var(--section-header-bg);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            margin-bottom: 0.75rem;
            max-width: 85%;
        }


        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .chart-details {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 12px;
            background-color: var(--chart-details-bg);
            border: 2px solid var(--chart-details-border);
            min-height: 120px;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .chart-details {
                margin-top: 2rem;
                padding: 2rem;
                border-radius: 16px;
                min-height: 140px;
            }
        }

        .chart-details.active {
            box-shadow: var(--shadow-lg);
            border-color: var(--nav-button-active-bg);
        }

        .chart-details h4 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
            transition: color 0.3s ease;
        }

        @media (min-width: 768px) {
            .chart-details h4 {
                font-size: 1.5rem;
                margin-bottom: 1.5rem;
            }
        }

        .chart-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        @media (min-width: 768px) {
            .chart-details-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
                margin-top: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .chart-details-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        .chart-detail-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .chart-detail-card {
                padding: 1.5rem;
                border-radius: 12px;
            }
        }

        .chart-detail-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: var(--nav-button-active-bg);
        }

        @media (min-width: 768px) {
            .chart-detail-card:hover {
                transform: translateY(-2px);
            }
        }

        .chart-detail-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }

        @media (min-width: 768px) {
            .chart-detail-label {
                font-size: 0.95rem;
                margin-bottom: 0.75rem;
            }
        }

        .chart-detail-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-color);
        }

        @media (min-width: 768px) {
            .chart-detail-value {
                font-size: 1.25rem;
            }
        }

        .chart-detail-percentage {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--nav-button-active-bg) 0%, var(--header-bg-end) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (min-width: 768px) {
            .chart-detail-percentage {
                font-size: 2.5rem;
            }
        }

        html {
            scroll-behavior: smooth;
        }

        .syllabus-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        @media (min-width: 768px) {
            .syllabus-item-header {
                flex-wrap: nowrap;
                gap: 0;
            }
        }

        .syllabus-item-title {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 200px;
        }
         .syllabus-item-title .font-medium { 
            cursor: pointer;
        }

        @media (min-width: 768px) {
            .syllabus-item-title {
                min-width: auto;
            }
        }

        .sub-topic-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0.75rem;
            padding-left: 1.5rem;
        }

        @media (min-width: 768px) {
            .sub-topic-list {
                margin-top: 1rem;
                padding-left: 2rem;
            }
        }

        .sub-topic-list.expanded {
            max-height: 1000px;
            padding: 0.75rem 0 0.75rem 1.5rem;
        }

        @media (min-width: 768px) {
            .sub-topic-list.expanded {
                padding: 1rem 0 1rem 2rem;
            }
        }

        .sub-topic-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .sub-topic-item-clickable-area { 
            display: flex;
            align-items: center;
            flex: 1;
            cursor: pointer;
            min-width: 150px; 
        }


        @media (min-width: 768px) {
            .sub-topic-item {
                padding: 0.75rem;
                border-radius: 8px;
                flex-wrap: nowrap;
                gap: 0;
            }
        }

        body.dark-mode .sub-topic-item {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .sub-topic-item:hover {
            background-color: rgba(102, 126, 234, 0.1);
            transform: translateX(4px);
        }

        @media (min-width: 768px) {
            .sub-topic-item:hover {
                transform: translateX(8px);
            }
        }

        .sub-topic-item.completed {
            background-color: rgba(16, 185, 129, 0.2) !important; 
            border-color: var(--accent-green) !important;
        }

        .sub-topic-item.partial {
            background-color: rgba(245, 158, 11, 0.2) !important; 
            border-color: var(--accent-yellow) !important;
        }
        
        /* Resource Modal Styles */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            margin-bottom: 1rem;
            background-color: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .resource-list {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
            max-height: 350px;
            overflow-y: auto;
        }
        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            background-color: var(--section-header-bg);
            margin-bottom: 0.5rem;
            gap: 0.75rem;
        }
        .resource-item a {
            color: var(--nav-button-active-bg);
            font-weight: 500;
            text-decoration: none;
            word-break: break-all;
            flex: 1;
        }
        .resource-item-delete {
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            flex-shrink: 0;
        }
        .youtube-thumbnail-container {
            position: relative;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 0.75rem;
        }
        .youtube-thumbnail-container img {
            width: 100%;
            display: block;
            transition: transform 0.3s ease;
        }
        .youtube-thumbnail-container:hover img {
            transform: scale(1.05);
        }
        .youtube-play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }
        .youtube-play-button svg {
            color: white;
            width: 30px;
            height: 30px;
            margin-left: 4px; /* Optical alignment */
        }
        .youtube-thumbnail-container:hover .youtube-play-button {
            background-color: rgba(239, 68, 68, 0.8); /* red-500 */
        }
        .resource-video-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
                /* --- Additional CSS (add this inside your <style> tag) --- */
        
        .resource-item.video-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .youtube-thumbnail-container.compact {
            width: 120px;
            flex-shrink: 0;
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
        }
        .youtube-thumbnail-container.compact img {
            width: 100%;
            height: auto;
            display: block;
        }
        .youtube-play-button.compact-play {
            width: 40px;
            height: 40px;
        }
        .youtube-play-button.compact-play svg {
            width: 20px;
            height: 20px;
        }
        .resource-info {
            flex: 1;
            min-width: 0;
        }
        .watch-on-youtube-link {
            display: block;
            text-align: center;
            font-size: 0.8rem;
            color: var(--nav-button-color);
            margin-top: 0.5rem;
            text-decoration: underline;
        }
        .video-player-wrapper {
             width: 100%;
        }
        
        /* Toast Notification */
        .toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-xl);
            z-index: 9999;
            transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast-notification.show {
            bottom: 20px;
        }
        .toast-notification.success {
            background-color: var(--toast-success-bg);
        }
        .toast-notification.error {
            background-color: var(--toast-error-bg);
        }

        .content-wrapper {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        @media (min-width: 768px) {
            .content-wrapper {
                padding: 0 2rem;
            }
        }

        @media (max-width: 767px) {
            .container {
                padding: 0.75rem;
            }
            
            .header {
                margin-bottom: 3rem; 
            }
            
            .section-header h3 {
                font-size: 1rem;
                line-height: 1.3;
            }
            
            .timeline-item {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }
            
            .timeline-icon {
                font-size: 1.5rem;
            }
            .chart-container .chartjs-legend ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            .llm-buttons {
                justify-content: flex-start; 
                 width: 100%; 
                 margin-left: 0; 
                 margin-top: 0.5rem; 
            }
            .sub-topic-item .llm-buttons {
                margin-left: calc(16px + 0.5rem); 
            }
             .llm-modal-content .options-container label {
                font-size: 0.9em; 
            }
            .llm-modal-content .llm-action-buttons .llm-button {
                padding: 0.4rem 0.8rem; 
                font-size: 0.8rem;
            }
            /* Styling for KaTeX Math Rendering */
.katex-display {
    display: block;
    margin: 1em auto; /* Center the block and add vertical space */
    text-align: center;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 0.5em 0.2em;
}

/* Enhanced styling for the explanation area */
#llmAnswerArea {
    margin-top: 1.5em;
    padding: 1em 1.5em;
    border-radius: 8px;
    display: none;
    line-height: 1.7; /* Increased line height for readability */
    background-color: var(--section-header-bg);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
}
/* [NEW] Desktop-specific split-screen layout for Video+Chat */
@media (min-width: 1024px) {
    #videoChatModalBox {
        flex-direction: row; /* Change to horizontal layout */
        gap: 1.5rem;
        padding: 1.5rem;
    }
    #videoPlayerContainer {
        flex: 2; /* Video takes up 2/3 of the space */
        margin-bottom: 0; /* Remove bottom margin */
        transition: flex 0.3s ease;
    }
    #videoChatContainer {
        flex: 1; /* Chat takes up 1/3 of the space */
        border-top: none; /* Remove top border */
        border-left: 1px solid var(--border-color); /* Add a side border */
        padding-top: 0;
        padding-left: 1.5rem;
        transition: all 0.3s ease;
    }


    /* Styles for when the chat is collapsed */
    #videoChatModalBox.chat-collapsed #videoChatContainer {
        flex: 0;
        width: 0;
        padding: 0;
        margin-left: -1.5rem; /* Hide it completely */
        opacity: 0;
        overflow: hidden;
    }
    #videoChatModalBox.chat-collapsed #videoPlayerContainer {
        flex: 1; /* Video takes up all the space */
    }
}

        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="header">
            <h1 id="mainHeaderTitle">GATE Preparation</h1>
            <p>Your personalized roadmap to success</p>
            <div class="header-controls">
                <button id="apiKeyButton" class="header-icon-button" title="Set API Key">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="userSettingsButton" class="header-icon-button" title="User Settings">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path></svg>
                </button>
                <button id="themeToggle" class="header-icon-button" title="Toggle Theme">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path id="themeIconPath" fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.459 4.577a1 1 0 01-1.39.043l-1.474-1.106a1 1 0 01.043-1.39l1.106-1.474a1 1 0 011.39-.043l1.474 1.106a1 1 0 01-.043 1.39l-1.106 1.474zM5.541 4.423a1 1 0 01.043 1.39L4.478 6.997a1 1 0 01-1.39-.043L1.614 5.48a1 1 0 01.043-1.39l1.106-1.474a1 1 0 011.39.043zm9.418 0a1 1 0 01.043-1.39l1.106-1.474a1 1 0 011.39.043l1.474 1.106a1 1 0 01-.043 1.39l-1.106 1.474a1 1 0 01-1.39-.043zM3 10a1 1 0 01-1-1V8a1 1 0 112 0v1a1 1 0 01-1 1zm15 0a1 1 0 01-1-1V8a1 1 0 112 0v1a1 1 0 01-1 1zM7.05 15.05a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zm6.364-.707a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <div class="nav-buttons">
                <button id="navYourPrep" class="nav-button active"> Your GATE Prep</button>
                <button id="navProgressAnalytics" class="nav-button"> Progress Analytics</button>
                <button id="navAllAboutGate" class="nav-button"> All About GATE</button>
            </div>
        </div>

        <div class="container">
            <div id="yourGatePrepPage" class="page active">
                <div class="card">
                    <h2 class="section-title"> Overall Progress</h2>
                    <div class="study-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="overallProgress">0%</div>
                            <div class="stat-label">Syllabus Covered</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTopics">0</div>
                            <div class="stat-label">Total Topics</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completedTopics">0</div>
                            <div class="stat-label">Finished</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="questionsAnswered">0</div>
                            <div class="stat-label">Questions Answered</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    
                    <h2 class="section-title"> GATE CS Syllabus</h2> 
                    <div id="syllabus-container">
                    </div>
                </div>
            </div>

            <div id="progressAnalyticsPage" class="page">
                <div class="card">
                     <div class="section-header"> 
                        <h2 class="section-title"> Syllabus Analytics</h2>
                        <button class="toggle-card-content p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 rotate-180">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                    </div>
                    <div class="card-content-collapsible expanded">
                        <div class="responsive-grid two-col">
                            <div class="chart-container">
                                <canvas id="completionChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="durationChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="sectionCompletionChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">
                        <h2 class="section-title"> Question Performance</h2>
                        <button class="toggle-card-content p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 rotate-180">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                    </div>
                    <div class="card-content-collapsible expanded">
                        <div class="chart-container">
                            <canvas id="questionAccuracyChart"></canvas>
                        </div>
                        <div id="questionHistoryContainer" class="mt-4">
                             <p class="text-center opacity-75">Your question attempt history will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="allAboutGatePage" class="page">
                 <div class="card" id="timelinePlanCard"> 
                    <h2 class="section-title"> Timeline Plan</h2>
                    <div class="timeline-item">
                        <span class="timeline-icon"></span>
                        <div class="timeline-text">
                            <p class="font-semibold text-lg">Syllabus Completion</p>
                            <p class="opacity-75" id="syllabusCompletionTime">June YYYY  November YYYY (6 months)</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="timeline-icon"></span>
                        <div class="timeline-text">
                            <p class="font-semibold text-lg">PYQs + Revision</p>
                            <p class="opacity-75" id="pyqsRevisionTime">December YYYY  January YYYY (2 months)</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">
                        <h2 class="section-title"> Subject-wise Weightage Analysis</h2>
                         <button class="toggle-card-content p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                    </div>
                    <div class="card-content-collapsible">
                        <div class="table-container">
                            <table class="weightage-table">
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Weightage (%)</th>
                                        <th>Difficulty</th>
                                        <th>Importance</th>
                                        <th>Expected Days</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>Engineering Mathematics</td><td>12-15%</td><td>Medium</td><td>High</td><td>25 days</td></tr>
                                    <tr><td>Algorithms</td><td>10-12%</td><td>High</td><td>Very High</td><td>35 days</td></tr>
                                    <tr><td>Data Structures</td><td>8-10%</td><td>Medium</td><td>Very High</td><td>30 days</td></tr>
                                    <tr><td>Operating Systems</td><td>9-11%</td><td>Medium</td><td>High</td><td>25 days</td></tr>
                                    <tr><td>Computer Networks</td><td>8-10%</td><td>Medium</td><td>High</td><td>22 days</td></tr>
                                    <tr><td>Theory of Computation</td><td>7-9%</td><td>High</td><td>High</td><td>20 days</td></tr>
                                    <tr><td>Databases</td><td>7-9%</td><td>Medium</td><td>High</td><td>20 days</td></tr>
                                    <tr><td>Computer Organization</td><td>7-9%</td><td>High</td><td>Medium</td><td>18 days</td></tr>
                                    <tr><td>Compiler Design</td><td>5-7%</td><td>Medium</td><td>Medium</td><td>15 days</td></tr>
                                    <tr><td>Digital Logic</td><td>4-6%</td><td>Medium</td><td>Medium</td><td>12 days</td></tr>
                                    <tr><td>General Aptitude</td><td>15%</td><td>Low</td><td>High</td><td>10 days</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="responsive-grid two-col">
                            <div class="chart-container">
                                <canvas id="weightageBarChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="weightagePieChart"></canvas>
                            </div>
                        </div>
                        
                        <div id="chartDetailsContainer" class="chart-details">
                            <h4> Subject Analysis</h4>
                            <p class="text-center opacity-75 mb-4">Click on any section of the charts to see detailed breakdown</p>
                            <div id="chartDetailsContent" class="chart-details-grid">
                                <div class="chart-detail-card">
                                    <div class="chart-detail-label">Total Subjects</div>
                                    <div class="chart-detail-value">11</div>
                                </div>
                                <div class="chart-detail-card">
                                    <div class="chart-detail-label">High Priority</div>
                                    <div class="chart-detail-value">6 Subjects</div>
                                </div>
                                <div class="chart-detail-card">
                                    <div class="chart-detail-label">Technical Weight</div>
                                    <div class="chart-detail-value">70%</div>
                                </div>
                                <div class="chart-detail-card">
                                    <div class="chart-detail-label">Mathematics + Aptitude</div>
                                    <div class="chart-detail-value">30%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="section-title"> Recommended Study Flow</h2>
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-6 rounded-xl">
                        <div class="responsive-grid two-col">
                            <div>
                                <h3 class="font-bold text-lg mb-3 text-blue-700 dark:text-blue-300"> Phase 1: Foundation</h3>
                                <ul class="space-y-2">
                                    <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-3 flex-shrink-0"></span>Engineering Mathematics</li>
                                    <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-3 flex-shrink-0"></span>Programming & Data Structures</li>
                                    <li class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-3 flex-shrink-0"></span>Digital Logic</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-3 text-purple-700 dark:text-purple-300"> Phase 2: Core Systems</h3>
                                <ul class="space-y-2">
                                    <li class="flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-3 flex-shrink-0"></span>Computer Organization & Architecture</li>
                                    <li class="flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-3 flex-shrink-0"></span>Operating Systems</li>
                                    <li class="flex items-center"><span class="w-2 h-2 bg-purple-500 rounded-full mr-3 flex-shrink-0"></span>Computer Networks</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-3 text-green-700 dark:text-green-300"> Phase 3: Advanced</h3>
                                <ul class="space-y-2">
                                    <li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-3 flex-shrink-0"></span>Algorithms</li>
                                    <li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-3 flex-shrink-0"></span>Theory of Computation</li>
                                    <li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-3 flex-shrink-0"></span>Databases</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-3 text-orange-700 dark:text-orange-300"> Phase 4: Specialization</h3>
                                <ul class="space-y-2">
                                    <li class="flex items-center"><span class="w-2 h-2 bg-orange-500 rounded-full mr-3 flex-shrink-0"></span>Compiler Design</li>
                                    <li class="flex items-center"><span class="w-2 h-2 bg-orange-500 rounded-full mr-3 flex-shrink-0"></span>General Aptitude</li>
                                    <li class="flex items-center"><span class="w-2 h-2 bg-orange-500 rounded-full mr-3 flex-shrink-0"></span>Revision & PYQs</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="section-title"> GATE Exam Details</h2>
                    <div class="responsive-grid two-col">
                        <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 p-6 rounded-xl">
                            <h3 class="font-bold text-lg mb-3"> Important Dates</h3>
                            <ul class="space-y-2 text-sm">
                                <li id="appStartDate"><strong>Application Start:</strong> August YYYY</li>
                                <li id="appEndDate"><strong>Application End:</strong> September YYYY</li>
                                <li id="examDate"><strong>Exam Date:</strong> February YYYY</li>
                                <li id="resultDate"><strong>Result:</strong> March YYYY</li>
                            </ul>
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 p-6 rounded-xl">
                            <h3 class="font-bold text-lg mb-3"> Exam Pattern</h3>
                            <ul class="space-y-2 text-sm">
                                <li><strong>Duration:</strong> 3 hours</li>
                                <li><strong>Total Marks:</strong> 100</li>
                                <li><strong>Questions:</strong> 65 (MCQ + NAT)</li>
                                <li><strong>Negative Marking:</strong> 1/3 for 1-mark, 2/3 for 2-mark</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Initial User Details Modal -->
        <div id="userDetailsOverlay" class="user-details-overlay modal-overlay">
            <div class="user-details-modal modal-content-box">
                <div class="modal-content-box-inner">
                    <h2>Welcome! Tell us about yourself.</h2>
                    <p class="text-center opacity-75 mb-6">This will help personalize your preparation plan.</p>
                    <form id="userDetailsForm">
                        <div class="form-group">
                            <label for="userName" class="form-label">Full Name</label>
                            <input type="text" id="userName" name="userName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="userDob" class="form-label">Date of Birth</label>
                            <input type="date" id="userDob" name="userDob" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="gatePrepYear" class="form-label">Target GATE Year (e.g., 2025)</label>
                            <input type="number" id="gatePrepYear" name="gatePrepYear" class="form-input" min="2024" max="2035" placeholder="YYYY" required>
                        </div>
                        <div class="form-group">
                            <label for="graduationYear" class="form-label">Graduation Year</label>
                            <input type="number" id="graduationYear" name="graduationYear" class="form-input" min="2000" max="2035" placeholder="YYYY" required>
                        </div>
                        <button type="submit" class="primary-button">Let's Get Started! </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Login Welcome Modal -->
        <div id="loginCongratsOverlay" class="login-congrats-overlay modal-overlay">
            <div class="login-congrats-modal modal-content-box">
                <h2 id="loginCongratsTitle"> Welcome, [User Name]!</h2>
                <p>Your details are saved. Let's begin your GATE preparation journey!</p>
                <button id="closeLoginCongrats" class="primary-button">Start Preparing! </button>
            </div>
        </div>

        <!-- Full Syllabus Completion Modal -->
        <div id="congratulationsOverlay" class="congratulations-overlay modal-overlay">
            <div class="congratulations-modal modal-content-box">
                <h2> Congratulations!</h2>
                <p>You have successfully completed the entire GATE CS Syllabus!</p>
                <button id="closeCongratulations" class="primary-button">Awesome! </button>
            </div>
        </div>

        <!-- Main LLM Interaction Modal -->
        <div id="llmResponseOverlay" class="modal-overlay">
            <div id="llmModalBox" class="modal-content-box" style="max-width: 800px;">
                <button class="modal-close-button" id="closeLlmModal">&times;</button>
                <h3 id="llmModalTitle">LLM Interaction</h3>
                <div id="llmModalContent" class="llm-modal-content">
                    <!-- Content dynamically injected -->
                </div>
            </div>
        </div>

        <!-- User Settings / Profile Modal -->
        <div id="userSettingsOverlay" class="modal-overlay">
            <div class="modal-content-box" style="max-width: 600px;">
                <button class="modal-close-button" id="closeUserSettingsModal">&times;</button>
                <div class="modal-content-box-inner">
                    <h3> User Profile</h3>
                    <form id="userSettingsForm">
                        <div class="form-group">
                            <label for="settingUserName" class="form-label">Full Name</label>
                            <input type="text" id="settingUserName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="settingUserDob" class="form-label">Date of Birth</label>
                            <input type="date" id="settingUserDob" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="settingGatePrepYear" class="form-label">Target GATE Year</label>
                            <input type="number" id="settingGatePrepYear" class="form-input" min="2024" max="2035" required>
                        </div>
                        <div class="form-group">
                            <label for="settingGraduationYear" class="form-label">Graduation Year</label>
                            <input type="number" id="settingGraduationYear" class="form-input" min="2000" max="2035" required>
                        </div>
                        <button type="submit" class="primary-button">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- API Key Guidance Modal -->
        <div id="apiKeyInfoOverlay" class="modal-overlay">
            <div class="modal-content-box" style="max-width: 550px;">
                <button class="modal-close-button" id="closeApiKeyInfoModal">&times;</button>
                <div class="modal-content-box-inner">
                    <h3> Gemini API Key</h3>
                    <p class="my-4">To use the AI-powered "Explain" and "Practice" features, you need a Google Gemini API key. It's free and easy to get.</p>
                    <ol class="list-decimal list-inside text-left space-y-2 mb-4">
                        <li>Go to <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-500 underline font-semibold">Google AI Studio</a>.</li>
                        <li>Click "Create API key in new project".</li>
                        <li>Copy the generated API key.</li>
                        <li>Paste it below and click Save.</li>
                    </ol>
                    <form id="apiKeyInfoForm">
                        <div class="form-group">
                            <label for="infoApiKey" class="form-label">Your Gemini API Key</label>
                            <input type="password" id="infoApiKey" class="form-input" placeholder="Paste your API key here" required>
                        </div>
                        <button type="submit" class="primary-button">Save and Enable AI Features</button>
                    </form>
                </div>
            </div>
        </div>
        


<!-- [REFACTORED] Main Resources Modal -->
<div id="resourcesOverlay" class="modal-overlay">
    <div class="modal-content-box" style="max-width: 800px;">
        <button class="modal-close-button" id="closeResourcesModal"></button>
        <div class="modal-content-box-inner">
            <div class="flex justify-between items-center mb-4">
                <h3 id="resourcesModalTitle" class="m-0">Resources</h3>
                <button id="showAddResourceModalBtn" class="llm-button" style="background-color: var(--accent-blue); border-color: var(--accent-blue);">+ Add New</button>
            </div>
            <div id="resourcesModalContent" class="overflow-y-auto">
                <!-- Dynamic content here -->
            </div>
        </div>
    </div>
</div>

<!-- [REFACTORED] Modal for adding a new resource URL (Now handles all types) -->
<div id="addResourceUrlOverlay" class="modal-overlay">
    <div class="modal-content-box" style="max-width: 500px;">
        <button class="modal-close-button" id="closeAddResourceUrlModal"></button>
        <div class="modal-content-box-inner">
            <h3>Add New Resource</h3>
            <p class="my-3 opacity-75">Enter a URL (e.g., YouTube, GeeksForGeeks, etc.).</p>
            <form id="addResourceUrlForm">
                <div class="form-group">
                    <label for="newResourceUrl" class="form-label">Resource URL</label>
                    <input type="url" id="newResourceUrl" class="form-input" placeholder="https://..." required>
                </div>
                <div class="form-group" id="resourceTitleGroup" style="display: none;">
                    <label for="newResourceTitle" class="form-label">Resource Title</label>
                    <input type="text" id="newResourceTitle" class="form-input" placeholder="e.g., 'My Favorite Algorithm Article'">
                </div>
                <button type="submit" class="primary-button">Add Resource</button>
            </form>
        </div>
    </div>
</div>

<!-- [REFACTORED] Modal for Video+Chat Interface -->
<div id="videoChatOverlay" class="modal-overlay">
    <div class="modal-content-box" id="videoChatModalBox" style="max-width: 95%; width: 1200px; height: 90vh;">
        <button class="modal-close-button" id="closeVideoChatModal"></button>
        <div id="videoPlayerContainer">
            <!-- Video Iframe will be injected here -->
        </div>
        <div id="videoChatContainer">
            <!-- Chat interface will be injected here -->
        </div>
                <!-- [REVISED] Toggle Chat Button with Emoji -->
        <!-- [REVISED] Best-in-class Interactive Toggle Button -->
<!-- [REVISED] Corrected Button HTML - layout classes removed -->
<button id="toggleChatBtn" title="Toggle Chat">
    <svg class="icon-hide-chat" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
    </svg>
     <!-- [NEW] Your custom SVG, optimized for CSS styling -->
    <svg class="icon-show-chat icon-robot" viewBox="0 0 900 768" preserveAspectRatio="xMidYMid meet">
        <g transform="translate(0.000000,768.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
            <path d="M4500 6950 c-30 -4 -91 -21 -134 -39 -179 -72 -311 -194 -396 -367 -28 -55 -50 -108 -50 -117 0 -9 -7 -42 -15 -74 -13 -48 -15 -166 -15 -749 l0 -691 -192 -6 c-178 -6 -233 -13 -373 -47 -89 -21 -236 -83 -310 -131 -16 -10 -37 -22 -45 -26 -37 -17 -171 -128 -236 -195 -153 -157 -272 -358 -314 -526 -5 -19 -14 -47 -21 -63 -30 -75 -34 -27 -37 494 l-2 515 57 29 c89 43 192 150 238 248 38 79 39 81 39 205 1 139 -10 182 -70 277 -118 185 -357 283 -553 227 -101 -29 -163 -66 -237 -139 -122 -123 -171 -271 -144 -439 7 -44 19 -94 28 -111 8 -16 22 -43 30 -60 37 -73 127 -158 222 -209 19 -10 41 -26 48 -34 9 -12 12 -133 12 -528 0 -576 7 -524 -82 -569 -72 -36 -122 -78 -171 -143 -48 -65 -68 -104 -91 -183 -24 -83 -24 -855 0 -938 44 -150 133 -259 269 -328 80 -41 145 -53 288 -53 l137 0 15 -37 c9 -21 20 -54 25 -73 54 -222 248 -499 465 -666 94 -72 241 -149 364 -191 203 -69 265 -72 1326 -72 1126 0 1134 0 1405 101 285 107 600 421 706 703 23 61 52 151 58 177 12 53 26 58 174 58 93 1 150 5 177 15 22 8 45 15 52 15 26 0 133 72 186 125 66 66 115 155 133 245 20 94 20 807 0 902 -19 92 -69 182 -141 253 -107 107 -248 155 -451 155 -129 0 -114 -10 -148 100 -22 70 -43 125 -68 172 -10 21 -16 42 -13 48 3 5 39 10 79 10 107 0 242 32 339 79 218 108 358 293 403 531 18 97 20 1397 3 1512 -28 179 -123 340 -274 463 -67 55 -131 89 -240 128 l-60 22 -1170 1 c-643 1 -1195 -2 -1225 -6z m2351 -347 c151 -47 257 -167 280 -316 6 -38 9 -333 7 -737 l-3 -675 -23 -55 c-52 -123 -151 -210 -277 -243 -26 -7 -406 -13 -1100 -16 l-1060 -6 -209 -108 c-162 -83 -212 -105 -222 -96 -12 10 -14 169 -14 938 0 938 2 1002 37 1086 31 73 104 157 168 193 94 52 43 50 1246 51 1020 1 1121 0 1170 -16z m-4605 -1029 c50 -21 72 -40 95 -86 43 -84 5 -188 -80 -224 -53 -22 -111 -18 -158 12 -55 37 -73 70 -73 141 0 80 38 133 115 161 42 15 57 14 101 -4z m1644 -1294 c6 -307 8 -317 78 -365 29 -20 49 -25 95 -25 58 0 109 22 400 172 41 21 52 26 127 63 41 20 100 50 131 66 l57 29 719 0 720 0 20 -22 c74 -82 153 -249 188 -398 22 -97 22 -1453 0 -1550 -33 -142 -89 -266 -169 -375 -108 -146 -273 -267 -457 -334 -144 -52 -121 -51 -1224 -51 -998 0 -1028 1 -1118 21 -50 11 -96 24 -102 30 -5 5 -15 9 -22 9 -22 0 -146 62 -208 105 -88 60 -161 130 -226 218 -57 76 -149 250 -149 282 0 9 -4 25 -10 35 -5 10 -17 69 -25 132 -22 164 -22 1242 0 1406 8 63 20 122 25 132 6 10 10 26 10 34 0 9 14 45 30 79 17 35 30 67 30 70 0 14 107 164 155 215 96 106 306 239 406 258 19 4 43 11 54 17 33 17 130 25 300 23 l160 -1 5 -275z m-1532 -1252 c2 -403 0 -508 -10 -509 -78 -4 -205 5 -231 16 -41 17 -81 61 -96 104 -7 23 -11 152 -11 396 0 393 1 404 56 458 37 38 73 46 189 44 l100 -2 3 -507z m4702 485 c19 -12 44 -37 55 -55 19 -32 20 -51 20 -430 l0 -396 -31 -39 c-49 -61 -88 -74 -207 -71 l-102 3 -3 495 c-1 272 0 501 3 509 4 10 30 12 118 10 94 -4 118 -8 147 -26z"/>
            <path d="M4680 6077 c-48 -25 -99 -99 -100 -145 0 -57 53 -135 109 -158 49 -21 1945 -21 1994 0 76 32 118 120 96 199 -15 53 -43 84 -94 108 -38 18 -88 19 -1000 18 l-960 0 -45 -22z"/>
            <path d="M4685 5400 c-57 -36 -63 -43 -85 -91 -26 -55 -22 -98 13 -149 32 -48 66 -70 122 -78 63 -9 1878 -8 1926 1 51 10 105 67 119 125 9 39 8 55 -5 92 -19 54 -36 73 -87 100 -38 20 -51 20 -1006 19 -932 0 -968 -1 -997 -19z"/>
            <path d="M3643 3520 c-23 -12 -52 -38 -65 -58 -22 -36 -23 -44 -23 -262 0 -218 1 -226 23 -257 41 -57 80 -78 147 -78 67 0 111 24 146 81 17 29 19 51 19 254 0 208 -1 225 -21 256 -47 77 -146 105 -226 64z"/>
            <path d="M5365 3529 c-17 -4 -46 -25 -65 -44 l-35 -36 -3 -222 c-4 -258 0 -281 60 -329 37 -29 49 -33 103 -33 52 0 67 4 98 28 70 54 77 80 77 307 0 178 -2 205 -19 238 -45 87 -121 119 -216 91z"/>
            <path d="M4186 2513 c-16 -3 -46 -23 -72 -50 -43 -44 -44 -47 -44 -110 0 -54 4 -70 26 -99 14 -18 41 -43 59 -54 31 -19 49 -20 422 -20 l390 0 41 30 c46 33 82 94 82 139 0 43 -35 105 -78 138 l-37 28 -380 1 c-209 1 -393 -1 -409 -3z"/>
        </g>
    </svg>
</button>
    </div>
</div>
<!-- [NEW] Custom Confirmation Modal -->
<div id="confirmationOverlay" class="modal-overlay">
    <div class="modal-content-box" style="max-width: 400px;">
        <div class="modal-content-box-inner text-center">
            <h3 id="confirmationTitle" class="text-lg font-bold">Are you sure?</h3>
            <p id="confirmationMessage" class="my-4 opacity-80">You will not be able to recover this item.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="confirmBtn" class="llm-button" style="background-color: var(--accent-red); border-color: var(--accent-red);">Yes, remove it</button>
                <button id="cancelBtn" class="llm-button" style="background-color: var(--nav-button-color); border-color: var(--nav-button-color);">Cancel</button>
            </div>
        </div>
    </div>
</div>

    </div>

       <script>
const syllabusData = [ 
    {
        section: "Section 1: Engineering Mathematics",
        topics: [
            {
                name: "Discrete Mathematics",
                subtopics: ["Propositional and first order logic", "Sets, relations, functions, partial orders and lattices", "Monoids, Groups", "Graphs: connectivity, matching, colouring", "Combinatorics: counting, recurrence relations, generating functions"]
            },
            {
                name: "Linear Algebra",
                subtopics: ["Matrices, determinants, system of linear equations", "Eigenvalues and eigenvectors", "LU decomposition"]
            },
            {
                name: "Calculus",
                subtopics: ["Limits, continuity and differentiability", "Maxima and minima", "Mean value theorem", "Integration"]
            },
            {
                name: "Probability and Statistics",
                subtopics: ["Random variables", "Uniform, normal, exponential, Poisson and binomial distributions", "Mean, median, mode and standard deviation", "Conditional probability and Bayes theorem"]
            }
        ]
    },
    {
        section: "Section 2: Digital Logic",
        topics: [
            {
                name: "Digital Logic",
                subtopics: ["Boolean algebra", "Combinational and sequential circuits", "Minimization", "Number representations and computer arithmetic (fixed and floating point)"]
            }
        ]
    },
    {
        section: "Section 3: Computer Organization and Architecture",
        topics: [
            {
                name: "Computer Organization and Architecture",
                subtopics: ["Machine instructions and addressing modes", "ALU, data-path and control unit", "Instruction pipelining, pipeline hazards", "Memory hierarchy: cache, main memory and secondary storage", "I/O interface (interrupt and DMA mode)"]
            }
        ]
    },
    {
        section: "Section 4: Programming and Data Structures",
        topics: [
            {
                name: "Programming and Data Structures",
                subtopics: ["Programming in C", "Recursion", "Arrays, stacks, queues, linked lists", "Trees, binary search trees, binary heaps", "Graphs"]
            }
        ]
    },
    {
        section: "Section 5: Algorithms",
        topics: [
            {
                name: "Algorithms",
                subtopics: ["Searching, sorting, hashing", "Asymptotic worst case time and space complexity", "Algorithm design techniques: greedy, dynamic programming and divide-and-conquer", "Graph traversals, minimum spanning trees, shortest paths"]
            }
        ]
    },
    {
        section: "Section 6: Theory of Computation",
        topics: [
            {
                name: "Theory of Computation",
                subtopics: ["Regular expressions and finite automata", "Context-free grammars and push-down automata", "Regular and context-free languages, pumping lemma", "Turing machines and undecidability"]
            }
        ]
    },
    {
        section: "Section 7: Compiler Design",
        topics: [
            {
                name: "Compiler Design",
                subtopics: ["Lexical analysis, parsing, syntax-directed translation", "Runtime environments", "Intermediate code generation", "Local optimization, data flow analyses"]
            }
        ]
    },
    {
        section: "Section 8: Operating System",
        topics: [
            {
                name: "Operating System",
                subtopics: ["System calls, processes, threads, inter-process communication", "Concurrency and synchronization", "Deadlock", "CPU and I/O scheduling", "Memory management and virtual memory", "File systems"]
            }
        ]
    },
    {
        section: "Section 9: Databases",
        topics: [
            {
                name: "Databases",
                subtopics: ["ER-model, relational model", "Relational algebra, tuple calculus, SQL", "Integrity constraints, normal forms", "File organization, indexing", "Transactions and concurrency control"]
            }
        ]
    },
    {
        section: "Section 10: Computer Networks",
        topics: [
            {
                name: "Computer Networks",
                subtopics: ["Concept of layering: OSI and TCP/IP Protocol Stacks", "Basics of packet, circuit and virtual circuit-switching", "Data link layer: framing, error detection, Medium Access Control", "Ethernet bridging, routing protocols", "TCP/UDP and sockets, congestion control", "Application layer protocols: DNS, SMTP, HTTP, FTP, Email"]
            }
        ]
    },
    {
        section: "Section 11: General Aptitude",
        topics: [
            {
                name: "Verbal Ability",
                subtopics: ["Basic English grammar", "Sentence completion", "Verbal analogies", "Word groups", "Critical reasoning and verbal deduction"]
            },
            {
                name: "Numerical Ability", 
                subtopics: ["Numerical computation", "Numerical estimation", "Numerical reasoning and data interpretation"]
            }
        ]
    }
];
const subjectWeightageData = [
    { subject: "Engineering Mathematics", weightage: 13.5, difficulty: "Medium", importance: "High", days: 25 },
    { subject: "Algorithms", weightage: 11, difficulty: "High", importance: "Very High", days: 35 },
    { subject: "Data Structures", weightage: 9, difficulty: "Medium", importance: "Very High", days: 30 },
    { subject: "Operating Systems", weightage: 10, difficulty: "Medium", importance: "High", days: 25 },
    { subject: "Computer Networks", weightage: 9, difficulty: "Medium", importance: "High", days: 22 },
    { subject: "Theory of Computation", weightage: 8, difficulty: "High", importance: "High", days: 20 },
    { subject: "Databases", weightage: 8, difficulty: "Medium", importance: "High", days: 20 },
    { subject: "Computer Organization", weightage: 8, difficulty: "High", importance: "Medium", days: 18 },
    { subject: "Compiler Design", weightage: 6, difficulty: "Medium", importance: "Medium", days: 15 },
    { subject: "Digital Logic", weightage: 5, difficulty: "Medium", importance: "Medium", days: 12 },
    { subject: "General Aptitude", weightage: 15, difficulty: "Low", importance: "High", days: 10 }
];
let charts = {};
let userDetails = null; 
let currentLlmChatHistory = [];
let currentLlmSubtopic = "";
let currentLlmSectionName = "";
let currentQuestionData = null;
let markdownConverter;
let currentVideoChatResource = null;

const sectionColors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899', '#14b8a6', '#6366f1', '#f97316', '#06b6d4', '#84cc16'];
const sectionClassNames = ['math-section', 'digital-section', 'computer-org-section', 'programming-section', 'algorithms-section', 'theory-section', 'compiler-section', 'os-section', 'database-section', 'network-section', 'aptitude-section'];

function lightenDarkenColor(col, amt) {
    let usePound = false;
    if (col[0] === "#") {
        col = col.slice(1);
        usePound = true;
    }
    const num = parseInt(col, 16);
    let r = (num >> 16) + amt;
    if (r > 255) r = 255; else if (r < 0) r = 0;
    let b = ((num >> 8) & 0x00FF) + amt;
    if (b > 255) b = 255; else if (b < 0) b = 0;
    let g = (num & 0x0000FF) + amt;
    if (g > 255) g = 255; else if (g < 0) g = 0;
    return (usePound ? "#" : "") + ((1 << 24) + (r << 16) + (b << 8) + g).toString(16).slice(1);
}

function loadData(key) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    } catch (e) {
        console.error(`Error loading ${key} from localStorage:`, e);
        return null;
    }
}
function saveData(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
        console.error(`Error saving ${key} to localStorage:`, e);
    }
}
function loadApiKey() { return localStorage.getItem('geminiApiKey'); }
function saveApiKey(key) { localStorage.setItem('geminiApiKey', key); }
function calculateSyllabusProgress() {
    const progress = loadData('gateProgress') || {};
    let totalItems = 0; let completedItems = 0; let partialItems = 0;
    syllabusData.forEach(section => section.topics.forEach(topic => topic.subtopics.forEach(subtopic => {
        totalItems++;
        if (progress[subtopic] === 'completed') completedItems++;
        else if (progress[subtopic] === 'partial') partialItems++;
    })));
    const percentage = totalItems > 0 ? Math.round(((completedItems + (partialItems * 0.5)) / totalItems) * 100) : 0; 
    return { completed: completedItems, partial: partialItems, total: totalItems, percentage: percentage };
}

function calculateSectionSyllabusProgress(section) {
    const progress = loadData('gateProgress') || {};
    let totalItems = 0; let completedItems = 0; let partialItems = 0;
    section.topics.forEach(topic => topic.subtopics.forEach(subtopic => {
        totalItems++;
        if (progress[subtopic] === 'completed') completedItems++;
        else if (progress[subtopic] === 'partial') partialItems++;
    }));
    const completionRate = totalItems > 0 ? (completedItems + (partialItems * 0.5)) / totalItems : 0; 
    return { completionRate: completionRate };
}

function updateOverallStats() {
    const syllabusProgress = calculateSyllabusProgress();
    const questionHistory = loadData('gateQuestionHistory') || {};
    const totalQuestionsAnswered = questionHistory ? Object.values(questionHistory).flat().length : 0;

    document.getElementById('overallProgress').textContent = `${syllabusProgress.percentage}%`;
    document.getElementById('totalTopics').textContent = syllabusProgress.total;
    document.getElementById('completedTopics').textContent = syllabusProgress.completed;
    document.getElementById('questionsAnswered').textContent = totalQuestionsAnswered;
}

function getExpansionStates() {
    const states = { sections: {}, subtopicLists: {} };
    document.querySelectorAll('.section-topics-list.expanded').forEach(el => {
        if (el.id) states.sections[el.id] = true;
    });
    document.querySelectorAll('.sub-topic-list.expanded').forEach(el => {
        if (el.id) states.subtopicLists[el.id] = true;
    });
    return states;
}

function applyExpansionStates(states) {
    if (!states) return;
    if (states.sections) {
        Object.keys(states.sections).forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.add('expanded');
                const header = el.previousElementSibling;
                if(header){
                    const toggleButton = header.querySelector('.toggle-section svg');
                    if (toggleButton) toggleButton.classList.add('rotate-180');
                }
            }
        });
    }
    if (states.subtopicLists) {
        Object.keys(states.subtopicLists).forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.add('expanded');
                 const header = el.closest('.syllabus-item')?.querySelector('.syllabus-item-header');
                if(header){
                    const toggleButton = header.querySelector('.toggle-subtopics svg');
                    if (toggleButton) toggleButton.classList.add('rotate-180');
                }
            }
        });
    }
}

function renderSyllabus(gatePrepYear = 2025) {
    const container = document.getElementById('syllabus-container');
    const progress = loadData('gateProgress') || {};
    container.innerHTML = ''; 

    const syllabusTitleElement = container.previousElementSibling; 
    if(syllabusTitleElement && syllabusTitleElement.tagName === 'H2'){
         syllabusTitleElement.textContent = ` GATE CS ${gatePrepYear} Syllabus`;
    }

    const apiKey = loadApiKey();

    syllabusData.forEach((section, sectionIndex) => {
        const sectionProgress = calculateSectionSyllabusProgress(section);
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'syllabus-section-container';
        let sectionClass = sectionClassNames[sectionIndex] || '';
        sectionDiv.innerHTML = `
            <div class="section-header ${sectionClass}" data-section-index="${sectionIndex}">
                <div class="flex items-center flex-1">
                    <span class="section-number">${sectionIndex + 1}</span>
                    <h3>${section.section}</h3>
                </div>
                <div class="flex items-center gap-3">
                    <div class="progress-indicator">
                        <span>${Math.round(sectionProgress.completionRate * 100)}%</span>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${sectionProgress.completionRate * 100}%"></div></div>
                    </div>
                    <button class="toggle-section p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                    </button>
                </div>
            </div>
            <div class="section-topics-list" id="section-${sectionIndex}">
                ${section.topics.map((topic, topicIndex) => `
                    <div class="syllabus-item ${getTopicStatus(topic, progress)}">
                        <div class="syllabus-item-header">
                            <div class="syllabus-item-title" data-section-index="${sectionIndex}" data-topic-index="${topicIndex}">
                                <div class="checkbox" data-topic-name="${topic.name}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                                </div>
                                <span class="font-medium">${topic.name}</span>
                            </div>
                            <div class="topic-actions">
                                <button class="resource-button" data-topic-name="${topic.name}" title="Manage Resources">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="toggle-subtopics p-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="sub-topic-list" id="subtopics-${sectionIndex}-${topicIndex}">
                            ${topic.subtopics.map(subtopic => `
                                <div class="sub-topic-item ${progress[subtopic] || ''}" data-subtopic-name="${subtopic}">
                                    <div class="sub-topic-item-clickable-area">
                                        <div class="checkbox mr-2" style="width: 16px; height: 16px;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></div>
                                        <span>${subtopic}</span>
                                    </div>
                                    <div class="llm-buttons">
                                        <button class="llm-button ${!apiKey ? 'disabled' : ''}" data-subtopic-name="${subtopic}" data-section-name="${section.section}" data-llm-action="explain" title="${!apiKey ? 'API Key not configured' : 'Explain with AI'}"> Explain</button>
                                        <button class="llm-button ${!apiKey ? 'disabled' : ''}" data-subtopic-name="${subtopic}" data-section-name="${section.section}" data-llm-action="question" data-question-type="mcq" title="${!apiKey ? 'API Key not configured' : 'Practice MCQ'}"> MCQ</button>
                                        <button class="llm-button ${!apiKey ? 'disabled' : ''}" data-subtopic-name="${subtopic}" data-section-name="${section.section}" data-llm-action="question" data-question-type="nat" title="${!apiKey ? 'API Key not configured' : 'Practice NAT'}"> NAT</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>`;
        container.appendChild(sectionDiv);
    });
}

function attachSyllabusEventListeners() {
    const syllabusContainer = document.getElementById('syllabus-container');
    if (!syllabusContainer) return;
    
    syllabusContainer.addEventListener('click', (e) => {
        const target = e.target;
        const sectionHeader = target.closest('.section-header');
        const toggleSectionButton = target.closest('.toggle-section');
        const topicTitle = target.closest('.syllabus-item-title .font-medium');
        const topicCheckbox = target.closest('.syllabus-item-title .checkbox');
        const toggleSubtopicsButton = target.closest('.toggle-subtopics');
        const subtopicArea = target.closest('.sub-topic-item-clickable-area');
        const llmButton = target.closest('.llm-button');
        const resourceButton = target.closest('.resource-button');
        e.stopPropagation();

        if (toggleSectionButton || sectionHeader && !target.closest('button')) {
            toggleSectionUI(sectionHeader);
        } else if (topicTitle || toggleSubtopicsButton) {
            const topicItem = target.closest('.syllabus-item');
            const subtopicList = topicItem.querySelector('.sub-topic-list');
            const icon = topicItem.querySelector('.toggle-subtopics svg');
            if(subtopicList && icon) {
                subtopicList.classList.toggle('expanded');
                icon.classList.toggle('rotate-180');
                saveExpansionStates();
            }
        } else if (topicCheckbox) {
            toggleTopicCompletion(topicCheckbox);
        } else if (subtopicArea) {
            toggleSubtopicCompletion(subtopicArea.closest('.sub-topic-item'));
        } else if (llmButton) {
            if (llmButton.classList.contains('disabled')) { 
                showApiKeyInfoModal();
                return;
            }
            currentLlmSubtopic = llmButton.dataset.subtopicName;
            currentLlmSectionName = llmButton.dataset.sectionName;
            const action = llmButton.dataset.llmAction;
            if (action === 'explain') {
                getLLMExplanation();
            } else if (action === 'question') {
                const questionType = llmButton.dataset.questionType;
                showLLMQuestionModal(questionType);
            }
        } else if (resourceButton) {
             showResourcesModal(resourceButton.dataset.topicName);
        }
    });
}

function getTopicStatus(topic, progress) {
    if (!topic.subtopics || topic.subtopics.length === 0) return ''; 
    const subtopicProgress = loadData('gateProgress') || {};
    const completedSubtopics = topic.subtopics.filter(subtopic => subtopicProgress[subtopic] === 'completed').length;
    const partialSubtopics = topic.subtopics.filter(subtopic => subtopicProgress[subtopic] === 'partial').length;
    
    if (completedSubtopics === topic.subtopics.length) return 'completed';
    if (completedSubtopics > 0 || partialSubtopics > 0) return 'partially-completed';
    return '';
}

function toggleSectionUI(headerElement) {
    if (!headerElement) return;
    const sectionContent = headerElement.nextElementSibling;
    const toggleButton = headerElement.querySelector('.toggle-section svg');
    if (sectionContent && toggleButton) {
        sectionContent.classList.toggle('expanded');
        toggleButton.classList.toggle('rotate-180');
        saveExpansionStates();
    }
}

function updateUIForTopicChange(element) {
    const progressData = loadData('gateProgress') || {};
    const topicItemElement = element.closest('.syllabus-item');
    if (!topicItemElement) return;
    const subtopicElements = topicItemElement.querySelectorAll('.sub-topic-item');
    subtopicElements.forEach(subEl => {
        const subName = subEl.dataset.subtopicName;
        subEl.classList.remove('completed', 'partial');
        if (progressData[subName] === 'completed') subEl.classList.add('completed');
        else if (progressData[subName] === 'partial') subEl.classList.add('partial');
    });

    const topicTitleElement = topicItemElement.querySelector('.syllabus-item-title');
    const sectionIndex = topicTitleElement.dataset.sectionIndex;
    const topicIndex = topicTitleElement.dataset.topicIndex;
    const topicData = syllabusData[sectionIndex].topics[topicIndex];
    const newTopicStatus = getTopicStatus(topicData, progressData);

    topicItemElement.classList.remove('completed', 'partially-completed');
    if (newTopicStatus) topicItemElement.classList.add(newTopicStatus);
    
    const sectionContainer = topicItemElement.closest('.syllabus-section-container');
    const sectionHeader = sectionContainer.querySelector('.section-header');
    const sectionData = syllabusData[sectionIndex];
    const sectionProgress = calculateSectionSyllabusProgress(sectionData);
    
    sectionHeader.querySelector('.progress-fill').style.width = `${sectionProgress.completionRate * 100}%`;
    sectionHeader.querySelector('.progress-indicator span').textContent = `${Math.round(sectionProgress.completionRate * 100)}%`;

    updateOverallStats();
    updateAllCharts();
    checkCompletion();
}

function toggleSubtopicCompletion(subtopicElement) {
    const subtopicName = subtopicElement.dataset.subtopicName;
    const progressData = loadData('gateProgress') || {};
    const currentState = progressData[subtopicName];

    if (currentState === 'completed') progressData[subtopicName] = 'partial';
    else if (currentState === 'partial') delete progressData[subtopicName];
    else progressData[subtopicName] = 'completed';
    
    saveData('gateProgress', progressData);
    updateUIForTopicChange(subtopicElement);
}

function toggleTopicCompletion(topicCheckboxElement) {
    const topicTitleElement = topicCheckboxElement.closest('.syllabus-item-title');
    const sectionIndex = topicTitleElement.dataset.sectionIndex;
    const topicIndex = topicTitleElement.dataset.topicIndex;
    const topicData = syllabusData[sectionIndex].topics[topicIndex];
    
    const progressData = loadData('gateProgress') || {};
    const currentStatus = getTopicStatus(topicData, progressData);

    const markAsCompleted = currentStatus !== 'completed';
    
    topicData.subtopics.forEach(subtopic => {
        if (markAsCompleted) progressData[subtopic] = 'completed';
        else delete progressData[subtopic];
    });

    saveData('gateProgress', progressData);
    updateUIForTopicChange(topicCheckboxElement);
}

function updateDynamicContent(details) {
    if (!details) return;
    const prepYear = parseInt(details.gatePrepYear);

    document.getElementById('mainHeaderTitle').textContent = `GATE ${prepYear} Preparation`;
    document.title = `GATE ${prepYear} Preparation`;

    const congratsMsgElement = document.querySelector('#congratulationsOverlay .congratulations-modal p');
    if(congratsMsgElement) {
        congratsMsgElement.textContent = `You have successfully completed the entire GATE CS ${prepYear} Syllabus!`;
    }

    const syllabusStartYear = prepYear - 1;
    document.getElementById('syllabusCompletionTime').textContent = `June ${syllabusStartYear}  November ${syllabusStartYear} (6 months)`;
    document.getElementById('pyqsRevisionTime').textContent = `December ${syllabusStartYear}  January ${prepYear} (2 months)`;
    document.getElementById('appStartDate').innerHTML = `<strong>Application Start:</strong> August ${syllabusStartYear}`;
    document.getElementById('appEndDate').innerHTML = `<strong>Application End:</strong> September ${syllabusStartYear}`;
    document.getElementById('examDate').innerHTML = `<strong>Exam Date:</strong> February ${prepYear}`;
    document.getElementById('resultDate').innerHTML = `<strong>Result:</strong> March ${prepYear}`;
}

function initializeCharts() {
    initCompletionChart(); 
    initDurationChart(); 
    initSectionCompletionChart();
    initQuestionAccuracyChart();
    initWeightageCharts(); 
}

function createChartBaseOptions(titleText) {
    const isMobile = window.innerWidth < 768;
    return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: titleText,
                color: getComputedStyle(document.documentElement).getPropertyValue('--chart-title-color').trim(),
                font: { size: isMobile ? 14 : 18, weight: 'bold', family: 'Inter' }
            },
            legend: { 
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: isMobile ? 10 : 20,
                    color: getComputedStyle(document.documentElement).getPropertyValue('--chart-legend-color').trim(),
                    font: { size: isMobile ? 10 : 12, family: 'Inter' }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim() },
                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(), font: {family: 'Inter'} }
            },
            x: {
                grid: { display: false },
                ticks: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim(),
                    maxRotation: isMobile ? 90 : 45, 
                    minRotation: isMobile ? 90 : 45, 
                    autoSkip: false,
                    font: { size: isMobile ? 9 : 11, family: 'Inter' } 
                }
            }
        }
    };
}
function initCompletionChart() {
    const ctx = document.getElementById('completionChart').getContext('2d');
    const progressData = calculateSyllabusProgress();
    const chartOptions = createChartBaseOptions('Syllabus Progress');
     if (chartOptions.plugins.legend.labels) {
        chartOptions.plugins.legend.labels.padding = window.innerWidth < 768 ? 15 : 25;
        chartOptions.plugins.legend.labels.font.size = window.innerWidth < 768 ? 11 : 14;
    }

    charts.completionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'In Progress', 'Not Started'],
            datasets: [{
                data: [progressData.completed, progressData.partial, progressData.total - progressData.completed - progressData.partial],
                backgroundColor: ['#10b981', '#f59e0b', '#e5e7eb'],
                borderColor: [lightenDarkenColor('#10b981', -20), lightenDarkenColor('#f59e0b', -20), lightenDarkenColor('#e5e7eb', -20)],
                borderWidth: 2, hoverOffset: 15
            }]
        },
        options: { ...chartOptions, animation: { animateRotate: true, duration: 1500 } }
    });
}

function initDurationChart() {
    const ctx = document.getElementById('durationChart').getContext('2d');
    const chartOptions = createChartBaseOptions('Study Progress Timeline');
    if(chartOptions.scales.y) {
        chartOptions.scales.y.max = 100;
        chartOptions.scales.y.ticks.callback = value => value + '%';
    }
    
    charts.durationChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Start', 'M1', 'M2', 'M3', 'M4', 'M5', 'M6', 'M7', 'M8'],
            datasets: [{
                label: 'Planned Progress', data: [0, 15, 25, 40, 55, 70, 85, 95, 100],
                borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', fill: true, tension: 0.4,
                pointRadius: 5, pointHoverRadius: 7
            }, {
                label: 'Actual Progress', data: [calculateSyllabusProgress().percentage],
                borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: false, tension: 0.4,
                pointRadius: 6, pointHoverRadius: 8
            }]
        },
        options: chartOptions
    });
}
function initSectionCompletionChart() {
    const ctx = document.getElementById('sectionCompletionChart').getContext('2d');
    const chartOptions = createChartBaseOptions('Section-wise Syllabus Completion');
    if(chartOptions.plugins.legend) chartOptions.plugins.legend.display = false;
    if(chartOptions.scales.y) {
        chartOptions.scales.y.max = 100;
        chartOptions.scales.y.ticks.callback = value => value + '%';
    }
    
    const sectionData = syllabusData.map(section => ({
        section: section.section.replace('Section ', 'S').replace('Engineering Mathematics', 'Eng. Maths').replace('Computer Organization and Architecture', 'COA').replace('Programming and Data Structures', 'Prog & DS'),
        completion: Math.round(calculateSectionSyllabusProgress(section).completionRate * 100)
    }));

    charts.sectionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sectionData.map(d => d.section),
            datasets: [{
                label: 'Completion %', data: sectionData.map(d => d.completion),
                backgroundColor: sectionColors,
                borderColor: sectionColors.map(color => lightenDarkenColor(color, -40)),
                borderWidth: 1.5, borderRadius: 6, borderSkipped: false
            }]
        },
        options: chartOptions
    });
}

function initQuestionAccuracyChart() {
    const ctx = document.getElementById('questionAccuracyChart').getContext('2d');
    const chartOptions = createChartBaseOptions('Question Accuracy by Subject');
    
    chartOptions.scales.x.stacked = true;
    chartOptions.scales.y.stacked = true;
    if(chartOptions.scales.y.ticks) chartOptions.scales.y.ticks.stepSize = 1;

    const accuracyData = getQuestionAccuracyData();

    charts.questionAccuracyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: accuracyData.labels,
            datasets: [
                {
                    label: 'Correct',
                    data: accuracyData.correct,
                    backgroundColor: '#10b981',
                },
                {
                    label: 'Incorrect',
                    data: accuracyData.incorrect,
                    backgroundColor: '#ef4444',
                }
            ]
        },
        options: chartOptions
    });
}

function initWeightageCharts() {
    const barCtx = document.getElementById('weightageBarChart').getContext('2d');
    const barOptions = createChartBaseOptions('Subject Weightage (Bar)');
    if(barOptions.plugins.legend) barOptions.plugins.legend.display = false;
    if(barOptions.scales.y) barOptions.scales.y.ticks.callback = value => value + '%';

    charts.weightageBar = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: subjectWeightageData.map(d => d.subject.length > 15 ? d.subject.substring(0,12) + "..." : d.subject),
            datasets: [{
                label: 'Weightage %',
                data: subjectWeightageData.map(d => d.weightage),
                backgroundColor: sectionColors,
                borderColor: sectionColors.map(c => lightenDarkenColor(c, -20)),
                borderWidth: 1
            }]
        },
        options: { ...barOptions, onClick: (e, el) => { if (el.length > 0) updateChartDetails(subjectWeightageData[el[0].index]); } }
    });

    const pieCtx = document.getElementById('weightagePieChart').getContext('2d');
    const pieOptions = createChartBaseOptions('Subject Weightage (Pie)');
    if(pieOptions.plugins.legend) pieOptions.plugins.legend.display = false;
    delete pieOptions.scales;

    charts.weightagePie = new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: subjectWeightageData.map(d => d.subject),
            datasets: [{
                data: subjectWeightageData.map(d => d.weightage),
                backgroundColor: sectionColors,
                borderColor: sectionColors.map(c => lightenDarkenColor(c, -20)),
                borderWidth: 1,
                hoverOffset: 8
            }]
        },
        options: { ...pieOptions, onClick: (e, el) => { if (el.length > 0) updateChartDetails(subjectWeightageData[el[0].index]); } }
    });
}

function updateChartDetails(subject) {
    const detailsContainer = document.getElementById('chartDetailsContainer');
    const contentContainer = document.getElementById('chartDetailsContent');
    detailsContainer.classList.add('active');
    contentContainer.innerHTML = `
        <div class="chart-detail-card"><div class="chart-detail-label">Subject</div><div class="chart-detail-value">${subject.subject}</div></div>
        <div class="chart-detail-card"><div class="chart-detail-label">Weightage</div><div class="chart-detail-percentage">${subject.weightage}%</div></div>
        <div class="chart-detail-card"><div class="chart-detail-label">Difficulty</div><div class="chart-detail-value">${subject.difficulty}</div></div>
        <div class="chart-detail-card"><div class="chart-detail-label">Importance</div><div class="chart-detail-value">${subject.importance}</div></div>
        <div class="chart-detail-card"><div class="chart-detail-label">Study Duration</div><div class="chart-detail-value">${subject.days} days</div></div>
        <div class="chart-detail-card"><div class="chart-detail-label">Total Questions</div><div class="chart-detail-value">${Math.round(subject.weightage * 0.65)} (~)</div></div>`;
    detailsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
function updateAllCharts() {
    const syllabusProgress = calculateSyllabusProgress();
    if (charts.completionChart) {
        charts.completionChart.data.datasets[0].data = [syllabusProgress.completed, syllabusProgress.partial, syllabusProgress.total - syllabusProgress.completed - syllabusProgress.partial];
        charts.completionChart.update('active');
    }
    if (charts.durationChart) {
        if (charts.durationChart.data.datasets[1]) {
             charts.durationChart.data.datasets[1].data = [syllabusProgress.percentage];
        }
        charts.durationChart.update('active');
    }
    if (charts.sectionChart) {
        charts.sectionChart.data.datasets[0].data = syllabusData.map(s => Math.round(calculateSectionSyllabusProgress(s).completionRate * 100));
        charts.sectionChart.update('active');
    }
    if (charts.questionAccuracyChart) {
        const accuracyData = getQuestionAccuracyData();
        charts.questionAccuracyChart.data.labels = accuracyData.labels;
        charts.questionAccuracyChart.data.datasets[0].data = accuracyData.correct;
        charts.questionAccuracyChart.data.datasets[1].data = accuracyData.incorrect;
        charts.questionAccuracyChart.update('active');
    }

    ['weightageBar', 'weightagePie'].forEach(key => {
         if (charts[key]) charts[key].update('none');
    });
}

// --- Theme Management ---
function initThemeToggle() {
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        updateThemeIcon(true);
    }
    themeToggle.addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcon(isDark);
        updateChartsForTheme();
    });
}
function updateThemeIcon(isDark) {
    document.getElementById('themeIconPath').setAttribute('d', isDark ? 'M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z' : 'M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z');
}

function updateChartsForTheme() {
    Object.values(charts).forEach(chart => {
        if (chart && chart.options) {
            const newOptions = createChartBaseOptions(chart.options.plugins.title.text); 
            chart.options.plugins.title.color = newOptions.plugins.title.color;
            chart.options.plugins.legend.labels.color = newOptions.plugins.legend.labels.color;
            if (chart.options.scales) {
               Object.keys(chart.options.scales).forEach(axis => {
                   if(chart.options.scales[axis].grid) chart.options.scales[axis].grid.color = newOptions.scales[axis].grid.color;
                   if(chart.options.scales[axis].ticks) chart.options.scales[axis].ticks.color = newOptions.scales[axis].ticks.color;
               });
            }
            chart.update('none');
        }
    });
}

function initNavigation() {
    const pages = { 
        navYourPrep: document.getElementById('yourGatePrepPage'),
        navProgressAnalytics: document.getElementById('progressAnalyticsPage'),
        navAllAboutGate: document.getElementById('allAboutGatePage')
    };
    const navButtons = document.querySelectorAll('.nav-button');
    
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetPageId = button.id;
            navButtons.forEach(btn => btn.classList.remove('active'));
            Object.values(pages).forEach(page => page.classList.remove('active'));
            
            pages[targetPageId].classList.add('active');
            button.classList.add('active');
        });
    });
}

function extractJson(text) {
    if (!text) return null;
    const jsonInMarkdown = text.match(/``````/);
    if (jsonInMarkdown && jsonInMarkdown[1]) {
        return jsonInMarkdown[1];
    }
    const firstBracket = text.indexOf('{');
    const firstSqBracket = text.indexOf('[');
    let startIndex = -1;
    if (firstBracket === -1) { startIndex = firstSqBracket; } 
    else if (firstSqBracket === -1) { startIndex = firstBracket; } 
    else { startIndex = Math.min(firstBracket, firstSqBracket); }
    if (startIndex === -1) return null;

    const lastBracket = text.lastIndexOf('}');
    const lastSqBracket = text.lastIndexOf(']');
    const endIndex = Math.max(lastBracket, lastSqBracket);
    if (endIndex > startIndex) { return text.substring(startIndex, endIndex + 1); }
    
    return null;
}

// --- Gemini API and LLM Logic (Optimized for Token Usage) ---
const MAX_HISTORY_LENGTH = 10; // Limit chat history to last 10 messages to reduce tokens

async function callGeminiAPI(promptContent, isJsonOutput = false) {
    const apiKey = loadApiKey();
    if (!apiKey) {
        showApiKeyInfoModal();
        throw new Error("API Key is not set.");
    }
    
    const API_URL_GEMINI = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
    try {
        // Optimize: Truncate history if too long
        if (Array.isArray(promptContent) && promptContent.length > MAX_HISTORY_LENGTH) {
            promptContent = promptContent.slice(-MAX_HISTORY_LENGTH);
        }

        const payload = {
            contents: promptContent,
            generationConfig: {
                temperature: 0.5,
                topK: 1,
                topP: 1,
                maxOutputTokens: isJsonOutput ? 512 : 1024, // Reduced max tokens for optimization
            }
        };
        if (isJsonOutput) { payload.generationConfig.responseMimeType = "application/json"; }
        
        const response = await fetch(API_URL_GEMINI, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const responseText = await response.text();
        if (!response.ok) {
            let errorData;
            try { errorData = JSON.parse(responseText); } 
            catch (e) { errorData = { error: { message: responseText || `HTTP error ${response.status}` }}; }
            const errorMessage = errorData?.error?.message || `HTTP error ${response.status}`;
            showToast(errorMessage, 'error');
            throw new Error(errorMessage);
        }
        const data = JSON.parse(responseText);
        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            return data.candidates[0].content.parts[0].text;
        } else if (data.promptFeedback?.blockReason) {
             const blockMessage = `Content blocked: ${data.promptFeedback.blockReason} - ${data.promptFeedback.blockReasonMessage || 'Safety settings triggered.'}`;
             showToast(blockMessage, 'error');
             throw new Error(blockMessage);
        } else { throw new Error("Unexpected API response structure from Gemini."); }
    } catch (error) {
        console.error("Gemini API call failed:", error);
        showToast(error.message, 'error');
        throw error;
    }
}

function displayFormattedContent(element, markdownText) {
    if (!markdownConverter) { 
        markdownConverter = new showdown.Converter({ simplifiedAutoLink: true, strikethrough: true, tables: true, tasklists: true, ghMentions: false, openLinksInNewWindow: true, emoji: true, underline: true, literalMidWordUnderscores: true, ghCodeBlocks: true });
    }
    try {
        const sanitizedMarkdown = markdownText.replace(/<script.*?>.*?<\/script>/gi, '');
        element.innerHTML = markdownConverter.makeHtml(sanitizedMarkdown);
    } catch(e) {
        console.error("Markdown conversion error:", e);
        element.textContent = markdownText; 
    }
}

function displayAndRenderMath(element, text) {
    displayFormattedContent(element, text);
    try {
        if (window.renderMathInElement) {
            renderMathInElement(element, {
                delimiters: [
                    {left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false},
                    {left: "\\(", right: "\\)", display: false}, {left: "\\[", right: "\\]", display: true}
                ], throwOnError: false
            });
        }
    } catch (e) { console.error("KaTeX rendering error:", e); }
}

function scrollToBottom(element) {
    if (element) requestAnimationFrame(() => { element.scrollTop = element.scrollHeight; });
}

async function getLLMExplanation() { 
    const modal = document.getElementById('llmResponseOverlay');
    const modalTitleEl = document.getElementById('llmModalTitle');
    const modalContentContainer = document.getElementById('llmModalContent'); 

    openModal(modal);

    modalTitleEl.textContent = `Explanation: ${currentLlmSubtopic}`;
    modalContentContainer.innerHTML = `
        <div class="llm-chat-interface" id="dynamicChatInterface">
            <div class="llm-chat-log" id="llmChatLog"></div>
            <div class="llm-chat-input-area" id="llmChatInputArea">
                <input type="text" id="llmChatMessage" placeholder="Ask a follow-up question..." aria-label="Chat message input" class="form-input">
                <button id="llmSendChatMessage" class="llm-button">Send</button>
            </div>
        </div>`; 
    const chatLog = document.getElementById('llmChatLog');
    currentLlmChatHistory = [];

    try {
        chatLog.innerHTML = `<div class="llm-message loading-container"><div class="loading-spinner"></div> Generating explanation...</div>`;
        scrollToBottom(chatLog);

        // Optimized prompt: Made more concise to reduce tokens
        const prompt = `Explain "${currentLlmSubtopic}" from "${currentLlmSectionName}" for GATE CS. Use Markdown and KaTeX ($ for inline, $$ for block). Bold key terms.`;
        
        const initialPayload = [{ role: "user", parts: [{ text: prompt }] }];
        const rawResponse = await callGeminiAPI(initialPayload);
        
        chatLog.innerHTML = ''; 
        const explanationMessageDiv = document.createElement('div');
        explanationMessageDiv.classList.add('llm-message');
        displayAndRenderMath(explanationMessageDiv, rawResponse);
        chatLog.appendChild(explanationMessageDiv);
        
        currentLlmChatHistory = [
            ...initialPayload,
            { role: "model", parts: [{ text: rawResponse }] }
        ];

        const followUpPromptDiv = document.createElement('div');
        followUpPromptDiv.classList.add('llm-message');
        followUpPromptDiv.innerHTML = `How can I help you further with <strong>${currentLlmSubtopic}</strong>?`;
        chatLog.appendChild(followUpPromptDiv);
        
        const sendChatBtn = document.getElementById('llmSendChatMessage');
        const chatMsgInput = document.getElementById('llmChatMessage');
        if (sendChatBtn) sendChatBtn.onclick = () => handleLlmChatSend();
        if (chatMsgInput) chatMsgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleLlmChatSend(); } });
        scrollToBottom(chatLog);
        if (chatMsgInput) chatMsgInput.focus();

    } catch (error) {
        console.error("LLM explanation failed:", error);
        if (chatLog) chatLog.innerHTML = `<p class="p-4 text-red-500 font-semibold">An error occurred: ${error.message}. Please check your API key in settings or try again.</p>`;
    }
}

async function showLLMQuestionModal(questionType = 'mcq') {
    const modal = document.getElementById('llmResponseOverlay');
    const modalTitleEl = document.getElementById('llmModalTitle');
    const modalContentContainer = document.getElementById('llmModalContent'); 

    openModal(modal);

    modalTitleEl.textContent = `Practice ${questionType.toUpperCase()}: ${currentLlmSubtopic}`;
    modalContentContainer.innerHTML = `
        <div class="difficulty-selector">
            <button class="difficulty-button easy" data-difficulty="Easy">Easy</button>
            <button class="difficulty-button moderate active" data-difficulty="Moderate">Moderate</button>
            <button class="difficulty-button hard" data-difficulty="Hard">Hard</button>
        </div>
        <div id="questionDisplayArea" class="flex-grow min-h-[200px] overflow-y-auto markdown-content"></div>`;
    
    const difficultyButtons = modalContentContainer.querySelectorAll('.difficulty-button');
    difficultyButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            difficultyButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            getLLMPracticeQuestion(btn.dataset.difficulty, questionType);
        });
    });

    getLLMPracticeQuestion('Moderate', questionType);
}

async function getLLMPracticeQuestion(difficulty, type = 'mcq') {
    const questionArea = document.getElementById('questionDisplayArea');
    if (!questionArea) return;

    questionArea.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div> Generating ${difficulty} ${type.toUpperCase()} question...</div>`;
    currentQuestionData = null;

    let prompt;
    if (type === 'nat') {
        // Optimized prompt: Concise version
        prompt = `Generate NAT question of ${difficulty} for "${currentLlmSubtopic}". Output JSON: {"question_text": "...", "correct_answer": 12.34, "explanation_text": "..."}. Use KaTeX and Markdown.`;
    } else { // MCQ
        prompt = `Generate MCQ of ${difficulty} for "${currentLlmSubtopic}". Output JSON: {"question_text": "...", "options": {"A":"...", "B":"...", "C":"...", "D":"..."}, "correct_answer_key": "A", "explanation_text": "..."}. Use KaTeX and Markdown.`;
    }
    try {
        const rawResponse = await callGeminiAPI([{ role: "user", parts: [{ text: prompt }] }], true); 
        const jsonString = extractJson(rawResponse);
        if (!jsonString) { throw new Error("The model did not return a valid JSON object."); }

        const qData = JSON.parse(jsonString);
        currentQuestionData = { ...qData, difficulty, type };

        if (type === 'mcq' && (!qData.options || Object.keys(qData.options).length !== 4 || !qData.correct_answer_key)) {
            throw new Error("MCQ data from API is malformed.");
        }
        if (type === 'nat' && typeof qData.correct_answer !== 'number') {
            throw new Error("NAT data from API is malformed (correct_answer is not a number).");
        }

        let answerAreaHtml = (type === 'mcq') 
            ? `<div class="options-container"></div>`
            : `<div class="nat-input-container"><input type="number" id="natAnswerInput" class="nat-input" placeholder="Enter your answer" step="any"></div>`;

        questionArea.innerHTML = `
            <div class="question-text"></div>
            ${answerAreaHtml}
            <div class="llm-action-buttons">
                <button id="llmSubmitAnswer" class="llm-button" style="background-color: var(--accent-blue); border-color: var(--accent-blue);">Submit Answer</button>
                <button id="llmNextQuestion" class="llm-button hidden" style="background-color: var(--accent-purple); border-color: var(--accent-purple);">Next Question </button>
            </div>
            <div id="llmAnswerArea"></div>`;
        
        displayAndRenderMath(questionArea.querySelector('.question-text'), qData.question_text);
        
        if (type === 'mcq') {
            const optionsContainerEl = questionArea.querySelector('.options-container');
            Object.entries(qData.options).forEach(([key, value]) => {
                const label = document.createElement('label');
                const radio = document.createElement('input');
                radio.type = 'radio'; radio.name = 'llmOption'; radio.value = key;
                label.appendChild(radio);
                const optionTextSpan = document.createElement('span');
                displayAndRenderMath(optionTextSpan, ` ${value}`);
                label.appendChild(optionTextSpan);
                optionsContainerEl.appendChild(label);
            });
        }

        document.getElementById('llmSubmitAnswer').addEventListener('click', handleAnswerSubmission);
        document.getElementById('llmNextQuestion').addEventListener('click', () => getLLMPracticeQuestion(difficulty, type));

    } catch (error) {
        console.error("Error getting or parsing LLM question:", error);
        questionArea.innerHTML = `<p class="text-red-500 font-semibold text-center">Error: Could not generate question.</p><p class="text-center text-sm opacity-75">${error.message}. Please try again.</p>`;
    }
}

function handleAnswerSubmission() {
    if (!currentQuestionData) return;

    let isCorrect = false;
    const type = currentQuestionData.type;

    if (type === 'mcq') {
        const selectedOption = document.querySelector('input[name="llmOption"]:checked');
        if (!selectedOption) {
            showToast("Please select an answer.", "error");
            return;
        }
        const userAnswer = selectedOption.value;
        isCorrect = userAnswer === currentQuestionData.correct_answer_key;
        document.querySelectorAll('.options-container label').forEach(label => {
            const radio = label.querySelector('input');
            radio.disabled = true;
            if (radio.value === currentQuestionData.correct_answer_key) label.classList.add('correct');
            else if (radio.value === userAnswer) label.classList.add('incorrect');
        });

    } else { // NAT
        const natInput = document.getElementById('natAnswerInput');
        if (natInput.value === '') {
            showToast("Please enter a numerical answer.", "error");
            return;
        }
        const userAnswer = parseFloat(natInput.value);
        const correctAnswer = currentQuestionData.correct_answer;
        const TOLERANCE = 1e-4;
        isCorrect = Math.abs(userAnswer - correctAnswer) < TOLERANCE;
        
        natInput.disabled = true;
        natInput.style.borderColor = isCorrect ? 'var(--accent-green)' : 'var(--accent-red)';
        natInput.style.color = isCorrect ? 'var(--accent-green)' : 'var(--accent-red)';
    }
    
    if (isCorrect && window.confetti) {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }

    const answerArea = document.getElementById('llmAnswerArea');
    const explanationHeader = type === 'nat' ? `### Explanation (Correct Answer: ${currentQuestionData.correct_answer})\n\n` : `### Explanation\n\n`;
    displayAndRenderMath(answerArea, `${explanationHeader}${currentQuestionData.explanation_text}`);
    answerArea.style.display = 'block';

    document.getElementById('llmSubmitAnswer').classList.add('hidden');
    document.getElementById('llmNextQuestion').classList.remove('hidden');

    saveQuestionAttempt(isCorrect, type);
    updateAllCharts();
    updateOverallStats();
    showToast(isCorrect ? "Correct!" : "Incorrect!", isCorrect ? "success" : "error");
}

function saveQuestionAttempt(isCorrect, type) {
    const history = loadData('gateQuestionHistory') || {};
    if (!history[currentLlmSectionName]) history[currentLlmSectionName] = [];
    
    history[currentLlmSectionName].push({
        subtopic: currentLlmSubtopic,
        difficulty: currentQuestionData.difficulty,
        type: type,
        isCorrect: isCorrect,
        timestamp: new Date().toISOString()
    });
    saveData('gateQuestionHistory', history);
}

function getQuestionAccuracyData() {
    const history = loadData('gateQuestionHistory') || {};
    const accuracy = {};

    syllabusData.forEach(section => {
        accuracy[section.section] = { correct: 0, incorrect: 0 };
    });

    if(history){
        for (const sectionName in history) {
            if (accuracy[sectionName]) {
                history[sectionName].forEach(attempt => {
                    if (attempt.isCorrect) accuracy[sectionName].correct++;
                    else accuracy[sectionName].incorrect++;
                });
            }
        }
    }
    
    const labels = Object.keys(accuracy).map(name => name.replace('Section ', 'S').replace('Engineering Mathematics', 'Eng. Maths').replace('Computer Organization and Architecture', 'COA').replace('Programming and Data Structures', 'Prog & DS'));
    const correct = Object.values(accuracy).map(data => data.correct);
    const incorrect = Object.values(accuracy).map(data => data.incorrect);

    return { labels, correct, incorrect };
}

async function handleLlmChatSend() {
    const messageInput = document.getElementById('llmChatMessage');
    const chatLog = document.getElementById('llmChatLog');
    const sendButton = document.getElementById('llmSendChatMessage');
    if (!messageInput || !chatLog || !sendButton) return;

    const userMessageText = messageInput.value.trim();
    if (!userMessageText) return;

    const userMessageDiv = document.createElement('div');
    userMessageDiv.classList.add('user-message');
    displayAndRenderMath(userMessageDiv, userMessageText); 
    chatLog.appendChild(userMessageDiv);
    scrollToBottom(chatLog);
    
    currentLlmChatHistory.push({ role: "user", parts: [{ text: userMessageText }] });
    messageInput.value = ""; messageInput.disabled = true; sendButton.disabled = true;

    const loadingDiv = document.createElement('div');
    loadingDiv.classList.add('llm-message', 'loading-container'); 
    loadingDiv.innerHTML = `<div class="loading-spinner"></div> Thinking...`;
    chatLog.appendChild(loadingDiv);
    scrollToBottom(chatLog);

    try {
        const llmResponseText = await callGeminiAPI(currentLlmChatHistory);
        if(chatLog.contains(loadingDiv)) chatLog.removeChild(loadingDiv);
        const llmMessageDiv = document.createElement('div');
        llmMessageDiv.classList.add('llm-message');
        displayAndRenderMath(llmMessageDiv, llmResponseText); 
        chatLog.appendChild(llmMessageDiv);
        scrollToBottom(chatLog);
        
        currentLlmChatHistory.push({ role: "model", parts: [{ text: llmResponseText }] });

    } catch (error) {
        console.error("LLM chat response error:", error);
        if (chatLog.contains(loadingDiv)) chatLog.removeChild(loadingDiv);
        const errorDiv = document.createElement('div');
        errorDiv.classList.add('llm-message');
        errorDiv.style.color = 'var(--accent-red)'; 
        errorDiv.textContent = `Sorry, I encountered an error: ${error.message}. Please try again.`;
        chatLog.appendChild(errorDiv);
        currentLlmChatHistory.pop();
    } finally {
        messageInput.disabled = false; sendButton.disabled = false; messageInput.focus();
    }
}

function closeLLMModal() { 
    closeModal(document.getElementById('llmResponseOverlay'));
    document.getElementById('llmModalContent').innerHTML = ''; 
    currentLlmChatHistory = []; currentLlmSubtopic = "";
    currentLlmSectionName = ""; currentQuestionData = null;
}

function openModal(modalOverlay) {
    if(modalOverlay) {
        modalOverlay.classList.add('show');
        document.documentElement.classList.add('modal-open');
        document.body.classList.add('modal-open');
    }
}
function closeModal(modalOverlay) {
     if(modalOverlay) {
        modalOverlay.classList.remove('show');
        document.documentElement.classList.remove('modal-open');
        document.body.classList.remove('modal-open');
    }
}

function checkCompletion() { if (calculateSyllabusProgress().percentage === 100) openModal(document.getElementById('congratulationsOverlay')); }

function showApiKeyInfoModal() { 
    const overlay = document.getElementById('apiKeyInfoOverlay');
    const apiKeyInput = document.getElementById('infoApiKey');
    apiKeyInput.value = loadApiKey() || '';
    openModal(overlay);
}

function initUserDetails() {
    userDetails = loadData('gateUserDetails');
    const userDetailsForm = document.getElementById('userDetailsForm');
    
    if (userDetails) {
        updateDynamicContent(userDetails);
        renderSyllabus(); 
        applyExpansionStates((loadData('gateProgress') || {}).expansionStates || {}); 
    } else {
        openModal(document.getElementById('userDetailsOverlay'));
        const currentYear = new Date().getFullYear();
        document.getElementById('gatePrepYear').value = currentYear + 1;
        document.getElementById('graduationYear').value = currentYear;
        renderSyllabus(); 
    }

    userDetailsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('userName').value.trim();
        const dob = document.getElementById('userDob').value;
        const prepYear = document.getElementById('gatePrepYear').value;
        const gradYear = document.getElementById('graduationYear').value;

        if (!name || !dob || !prepYear || !gradYear) { showToast("Please fill in all fields.", "error"); return; }
        if (parseInt(prepYear) < new Date().getFullYear() - 1 || parseInt(prepYear) > 2035) { showToast("Please enter a valid GATE Preparation Year.", "error"); return; }
        if (parseInt(gradYear) < 1980 || parseInt(gradYear) > 2040) { showToast("Please enter a valid Graduation Year.", "error"); return; }
        userDetails = { name, dob, gatePrepYear: parseInt(prepYear), graduationYear: parseInt(gradYear) };
        saveData('gateUserDetails', userDetails);
        updateDynamicContent(userDetails);
        renderSyllabus(); 
        applyExpansionStates((loadData('gateProgress') || {}).expansionStates || {});
        closeModal(document.getElementById('userDetailsOverlay')); 
        document.getElementById('loginCongratsTitle').textContent = ` Welcome, ${userDetails.name}!`;
        openModal(document.getElementById('loginCongratsOverlay'));
    });
}

function initUserSettings() {
    const settingsButton = document.getElementById('userSettingsButton');
    const settingsOverlay = document.getElementById('userSettingsOverlay');
    const settingsForm = document.getElementById('userSettingsForm');

    settingsButton.addEventListener('click', () => {
        const currentUser = loadData('gateUserDetails');
        if (currentUser) {
            document.getElementById('settingUserName').value = currentUser.name;
            document.getElementById('settingUserDob').value = currentUser.dob;
            document.getElementById('settingGatePrepYear').value = currentUser.gatePrepYear;
            document.getElementById('settingGraduationYear').value = currentUser.graduationYear;
            openModal(settingsOverlay);
        } else {
            showToast("Please set your initial details first.", "error");
            openModal(document.getElementById('userDetailsOverlay'));
        }
    });

    settingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('settingUserName').value.trim();
        const dob = document.getElementById('settingUserDob').value;
        const prepYear = document.getElementById('settingGatePrepYear').value;
        const gradYear = document.getElementById('settingGraduationYear').value;

        userDetails = { name, dob, gatePrepYear: parseInt(prepYear), graduationYear: parseInt(gradYear) };
        saveData('gateUserDetails', userDetails);
        updateDynamicContent(userDetails);
        renderSyllabus();
        closeModal(settingsOverlay);
        showToast('Profile updated successfully!');
    });
}

function initApiKeyInfo() {
    const apiKeyButton = document.getElementById('apiKeyButton');
    apiKeyButton.addEventListener('click', showApiKeyInfoModal);

    const infoForm = document.getElementById('apiKeyInfoForm');
    infoForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const apiKeyInput = document.getElementById('infoApiKey');
        const newApiKey = apiKeyInput.value.trim();
        if (newApiKey) {
            saveApiKey(newApiKey);
            const expansionStates = getExpansionStates();
            renderSyllabus();
            applyExpansionStates(expansionStates);
            closeModal(document.getElementById('apiKeyInfoOverlay'));
            showToast('API Key saved! AI features are now enabled.');
        } else {
            showToast('API Key cannot be empty.', 'error');
        }
    });
}

function initCollapsibleContent() {
    document.addEventListener('click', (e) => {
        const button = e.target.closest('.toggle-card-content');
        if (button) {
            const content = button.closest('.card').querySelector('.card-content-collapsible');
            const icon = button.querySelector('svg');
            if (content && icon) {
                content.classList.toggle('expanded');
                icon.classList.toggle('rotate-180');
            }
        }
    });
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => { toast.classList.add('show'); }, 100);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

// --- [REFACTORED] Resource Management Functions ---
function getYouTubeVideoId(url) {
    let videoId = null;
    try {
        const urlObj = new URL(url);
        if (urlObj.hostname === 'youtu.be') videoId = urlObj.pathname.slice(1).split('/')[0];
        else if (urlObj.hostname.includes('youtube.com')) videoId = urlObj.searchParams.get('v');
    } catch (e) { /* Fallback */ }

    if (!videoId) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        if (match && match[2] && match[2].length === 11) videoId = match[2];
    }
    return (videoId && /^[a-zA-Z0-9_-]{11}$/.test(videoId)) ? videoId : null;
}
async function fetchYouTubeVideoInfo(videoUrl) {
    const endpoint = `https://noembed.com/embed?url=${encodeURIComponent(videoUrl)}`;
    try {
        const response = await fetch(endpoint, { mode: 'cors' });
        if (!response.ok) return null;
        const data = await response.json();
        return { title: data?.title || "Untitled Video", author: data?.author_name || "Unknown Author" };
    } catch (error) {
        console.error("Failed to fetch YouTube info:", error);
        return null;
    }
}

function showResourcesModal(topicName) {
    const overlay = document.getElementById('resourcesOverlay');
    const titleEl = document.getElementById('resourcesModalTitle');
    const contentEl = document.getElementById('resourcesModalContent');

    titleEl.textContent = `Resources for ${topicName}`;

    const render = () => {
        const allKnownResources = loadData('gateResources') || {};
        const resources = allKnownResources[topicName] || [];
        let listHTML = '';

        if (resources.length > 0) {
            resources.forEach((res, index) => {
                const thumbnailHtml = res.videoId
                    ? `<img src="https://img.youtube.com/vi/${res.videoId}/mqdefault.jpg" alt="Video thumbnail" loading="lazy">`
                    : `<div class="link-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg></div>`;

                listHTML += `
                    <div class="resource-stack-item" data-index="${index}">
                        <div class="thumbnail-container">
                            ${thumbnailHtml}
                        </div>
                        <div class="info-container">
                            <h4 class="title">${res.title}</h4>
                            <p class="author">${res.author || new URL(res.url).hostname}</p>
                        </div>
                        <button class="delete-btn" title="Remove resource"></button>
                    </div>`;
            });
        } else {
            listHTML = `<p class="text-center opacity-70 my-4">No resources added for this topic yet. Add one to get started!</p>`;
        }

        contentEl.innerHTML = `<div class="resource-stack">${listHTML}</div>`;
        
        contentEl.querySelector('.resource-stack').addEventListener('click', (e) => {
            const item = e.target.closest('.resource-stack-item');
            if (!item) return;

            const index = parseInt(item.dataset.index, 10);
            const resource = resources[index];

            if (e.target.closest('.delete-btn')) {
                if (confirm(`Are you sure you want to remove "${resource.title}"?`)) {
                    resources.splice(index, 1);
                    saveData('gateResources', allKnownResources);
                    render();
                }
            } else {
                if(resource.videoId) showVideoChatModal(resource);
                else window.open(resource.url, '_blank');
            }
        });
    };

    render();
    openModal(overlay);
}
async function showVideoChatModal(resource) {
    currentVideoChatResource = resource;
    const overlay = document.getElementById('videoChatOverlay');
    const playerContainer = document.getElementById('videoPlayerContainer');
    const chatContainer = document.getElementById('videoChatContainer');
    
    playerContainer.innerHTML = `<div class="video-container"><iframe src="https://www.youtube.com/embed/${resource.videoId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
    
    chatContainer.innerHTML = `
        <div class="llm-chat-interface">
            <div class="llm-chat-log" id="llmChatLog"></div>
            <div class="llm-chat-input-area" id="llmChatInputArea">
                <input type="text" id="llmChatMessage" placeholder="Ask about this video..." class="form-input">
                <button id="llmSendChatMessage" class="llm-button">Send</button>
            </div>
        </div>`;
    
    overlay.classList.remove('chat-hidden');
    openModal(overlay);

    const chatLog = document.getElementById('llmChatLog');
    const sendButton = document.getElementById('llmSendChatMessage');
    const messageInput = document.getElementById('llmChatMessage');
    
    // Optimized: Concise system prompt
    currentLlmChatHistory = [{
        role: "user",
        parts: [{ text: `Helpful GATE assistant for video "${resource.title}". Answer related questions concisely.` }]
    }];

    sendButton.disabled = true; messageInput.disabled = true;
    chatLog.innerHTML = `<div class="llm-message loading-container"><div class="loading-spinner"></div> Preparing chat...</div>`;

    try {
        const initialResponse = await callGeminiAPI(currentLlmChatHistory);
        currentLlmChatHistory.push({ role: "model", parts: [{ text: initialResponse }] });
        
        chatLog.innerHTML = ''; 
        const llmMessageDiv = document.createElement('div');
        llmMessageDiv.classList.add('llm-message');
        displayAndRenderMath(llmMessageDiv, initialResponse); 
        chatLog.appendChild(llmMessageDiv);
        scrollToBottom(chatLog);
    } catch (error) {
        chatLog.innerHTML = `<p class="p-4 text-red-500 font-semibold">Could not start chat: ${error.message}</p>`;
    } finally {
        sendButton.disabled = false; messageInput.disabled = false; messageInput.focus();
        sendButton.onclick = () => handleLlmChatSend();
        messageInput.onkeypress = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendButton.click(); } };
    }
}

function initModalCloseButtons() {
    document.getElementById('closeCongratulations').addEventListener('click', () => closeModal(document.getElementById('congratulationsOverlay')));
    document.getElementById('closeLoginCongrats').addEventListener('click', () => closeModal(document.getElementById('loginCongratsOverlay')));
    document.getElementById('closeLlmModal').addEventListener('click', closeLLMModal);
    document.getElementById('closeUserSettingsModal').addEventListener('click', () => closeModal(document.getElementById('userSettingsOverlay')));
    document.getElementById('closeApiKeyInfoModal').addEventListener('click', () => closeModal(document.getElementById('apiKeyInfoOverlay')));
    document.getElementById('closeResourcesModal').addEventListener('click', () => closeModal(document.getElementById('resourcesOverlay')));
    document.getElementById('closeAddResourceUrlModal').addEventListener('click', () => closeModal(document.getElementById('addResourceUrlOverlay')));
    document.getElementById('closeVideoChatModal').addEventListener('click', () => {
        closeModal(document.getElementById('videoChatOverlay'));
        document.getElementById('videoPlayerContainer').innerHTML = '';
        currentVideoChatResource = null;
    });

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                if (this.id !== 'userDetailsOverlay') {
                    closeModal(this);
                    if (this.id === 'llmResponseOverlay') closeLLMModal();
                    if (this.id === 'videoChatOverlay') {
                        document.getElementById('videoPlayerContainer').innerHTML = '';
                        currentVideoChatResource = null;
                    }
                }
            }
        });
    });
    document.getElementById('toggleChatBtn').addEventListener('click', () => {
        document.getElementById('videoChatModalBox').classList.toggle('chat-hidden');
    });

    document.getElementById('showAddResourceModalBtn').addEventListener('click', () => {
        const titleGroup = document.getElementById('resourceTitleGroup');
        const urlInput = document.getElementById('newResourceUrl');
        const titleInput = document.getElementById('newResourceTitle');
        
        urlInput.oninput = () => {
            const isYouTube = getYouTubeVideoId(urlInput.value);
            titleGroup.style.display = isYouTube ? 'none' : 'block';
            titleInput.required = !isYouTube;
        };
        urlInput.oninput();
        openModal(document.getElementById('addResourceUrlOverlay'));
    });

    document.getElementById('addResourceUrlForm').onsubmit = async (e) => {
        e.preventDefault();
        const urlInput = document.getElementById('newResourceUrl');
        const titleInput = document.getElementById('newResourceTitle');
        const topicName = document.getElementById('resourcesModalTitle').textContent.replace('Resources for ', '');
        
        const url = urlInput.value.trim();
        const videoId = getYouTubeVideoId(url);
        
        const button = e.target.querySelector('button');
        button.disabled = true; button.textContent = 'Adding...';

        try {
            let newResource;
            if (videoId) {
                const info = await fetchYouTubeVideoInfo(url);
                if (!info) throw new Error("Could not fetch video information.");
                newResource = { videoId, url, ...info };
            } else {
                const title = titleInput.value.trim();
                if (!title) throw new Error("Title is required for non-YouTube links.");
                newResource = { url, title, author: new URL(url).hostname };
            }

            const allResources = loadData('gateResources') || {};
            if (!allResources[topicName]) allResources[topicName] = [];
            allResources[topicName].push(newResource);
            saveData('gateResources', allResources);
            
            showToast("Resource added successfully!", "success");
            showResourcesModal(topicName);
            closeModal(document.getElementById('addResourceUrlOverlay'));
            e.target.reset();

        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            button.disabled = false; button.textContent = 'Add Resource';
        }
    };
}

document.addEventListener('DOMContentLoaded', function() {
    try {
        markdownConverter = new showdown.Converter({
            simplifiedAutoLink: true, strikethrough: true, tables: true, tasklists: true,
            ghMentions: false, openLinksInNewWindow: true, emoji: true, underline: true,
            literalMidWordUnderscores: true, ghCodeBlocks: true,
        });
        showdown.setFlavor('github');
    } catch (e) {
        console.error("Failed to initialize Showdown.js.", e);
        markdownConverter = { makeHtml: (text) => text.replace(/</g, '<').replace(/>/g, '>').replace(/\n/g, '<br>') };
    }

    initUserDetails();
    initUserSettings();
    initApiKeyInfo();
    updateOverallStats();
    initializeCharts();
    initThemeToggle();
    initNavigation();
    initCollapsibleContent();
    attachSyllabusEventListeners();
    initModalCloseButtons();

    window.addEventListener('resize', () => {
        Object.values(charts).forEach(chart => chart?.resize());
    });
});

    </script>
</body>
</html>
